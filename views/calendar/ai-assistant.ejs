<%- include('../base-pm', {
    title: 'AI Calendar Assistant',
    description: 'AI-powered deadline extraction and SOL calculator'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-calendar-check me-2"></i>AI Calendar Assistant</h2>
            <p class="text-muted mb-0">Extract deadlines and calculate statute of limitations</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.total_suggestions || 0 %></h3>
                    <small>Total Suggestions</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.pending_count || 0 %></h3>
                    <small>Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.critical_count || 0 %></h3>
                    <small>Critical</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- SOL Calculator -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Statute of Limitations Calculator</h5>
                </div>
                <div class="card-body">
                    <form id="solForm">
                        <div class="mb-3">
                            <label class="form-label">Jurisdiction</label>
                            <select class="form-select" name="jurisdiction" required>
                                <option value="">Select...</option>
                                <% jurisdictions.forEach(j => { %>
                                <option value="<%= j %>"><%= j %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Case Type</label>
                            <select class="form-select" name="case_type" required>
                                <option value="">Select...</option>
                                <option value="Personal Injury">Personal Injury</option>
                                <option value="Medical Malpractice">Medical Malpractice</option>
                                <option value="Contract">Contract</option>
                                <option value="Property Damage">Property Damage</option>
                                <option value="Employment">Employment</option>
                                <option value="Civil Rights">Civil Rights</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Incident Date</label>
                            <input type="date" class="form-control" name="incident_date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Discovery Date (if applicable)</label>
                            <input type="date" class="form-control" name="discovery_date">
                        </div>
                        <button type="button" class="btn btn-outline-info me-2" id="loadSOLExampleBtn">
                            <i class="fas fa-flask me-1"></i>Example
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-calculator me-1"></i>Calculate
                        </button>
                    </form>

                    <div id="solResult" class="mt-4 d-none">
                        <hr>
                        <div id="solContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deadline Extractor -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Extract Deadlines from Document</h5>
                </div>
                <div class="card-body">
                    <form id="extractForm">
                        <div class="mb-3">
                            <label class="form-label">Document Text</label>
                            <textarea class="form-control" name="document_text" rows="8"
                                placeholder="Paste court order, contract, or other document..."></textarea>
                        </div>
                        <button type="button" class="btn btn-outline-info me-2" id="loadDeadlineExampleBtn">
                            <i class="fas fa-flask me-1"></i>Example
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-robot me-1"></i>Extract Deadlines
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Suggestions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Calendar Suggestions</h5>
        </div>
        <div class="card-body">
            <% const pending = suggestions.filter(s => s.status === 'pending'); %>
            <% if (pending.length > 0) { %>
            <div class="list-group">
                <% pending.forEach(s => { %>
                <div class="list-group-item <%= s.is_critical ? 'border-danger' : '' %>">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <% if (s.is_critical) { %>
                                    <span class="badge bg-danger me-1">CRITICAL</span>
                                <% } %>
                                <%= s.suggested_title %>
                            </h6>
                            <p class="mb-1">
                                <strong><%= s.suggested_date %></strong>
                                | Type: <%= s.suggested_deadline_type %>
                                <% if (s.case_title) { %> | Case: <%= s.case_title %><% } %>
                            </p>
                            <% if (s.legal_basis) { %>
                            <small class="text-muted"><%= s.legal_basis %></small>
                            <% } %>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success accept-btn" data-id="<%= s.id %>">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger reject-btn" data-id="<%= s.id %>">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
            <% } else { %>
            <p class="text-muted text-center">No pending suggestions</p>
            <% } %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load SOL Example Data
document.getElementById('loadSOLExampleBtn').addEventListener('click', function() {
    document.querySelector('#solForm [name=jurisdiction]').value = 'California';
    document.querySelector('#solForm [name=case_type]').value = 'Personal Injury';
    document.querySelector('#solForm [name=incident_date]').value = '2024-06-15';
    document.querySelector('#solForm [name=discovery_date]').value = '';
});

// Load Deadline Extractor Example Data
document.getElementById('loadDeadlineExampleBtn').addEventListener('click', function() {
    document.querySelector('[name=document_text]').value = `SUPERIOR COURT OF CALIFORNIA
COUNTY OF LOS ANGELES

Case No. 24STCV01234

ORDER SETTING CASE MANAGEMENT CONFERENCE AND DEADLINES

The Court, having reviewed the file in the above-entitled matter, hereby orders as follows:

1. CASE MANAGEMENT CONFERENCE: A Case Management Conference is scheduled for April 15, 2024 at 9:00 a.m. in Department 45.

2. DISCOVERY DEADLINES:
   a. All fact discovery shall be completed by June 30, 2024.
   b. Expert witness disclosures shall be exchanged by July 15, 2024.
   c. Expert discovery shall be completed by August 31, 2024.

3. MOTION DEADLINES:
   a. All law and motion matters, except motions in limine, shall be heard by September 15, 2024.
   b. Motions in limine shall be filed by October 1, 2024.

4. PRETRIAL REQUIREMENTS:
   a. Mandatory Settlement Conference: October 15, 2024 at 10:00 a.m.
   b. Final Status Conference: November 1, 2024 at 8:30 a.m.
   c. Joint Trial Documents due: November 8, 2024.

5. TRIAL DATE: Trial is scheduled to commence on November 18, 2024 at 9:00 a.m.

Failure to comply with this Order may result in sanctions, including monetary sanctions, issue sanctions, or dismissal.

IT IS SO ORDERED.

Dated: January 20, 2024

_______________________
Hon. Maria Rodriguez
Judge of the Superior Court`;
});

// SOL Calculator
document.getElementById('solForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    const btn = this.querySelector('button[type=submit]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';

    try {
        const res = await fetch('/api/ai-calendar/calculate-sol', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        const resultDiv = document.getElementById('solResult');
        const contentDiv = document.getElementById('solContent');
        resultDiv.classList.remove('d-none');

        if (result.found && result.aiAnalysis) {
            const a = result.aiAnalysis;
            const lp = a.limitation_period || {};

            let html = `
                <div class="alert alert-${a.is_critical ? 'danger' : (a.risk_assessment === 'high' ? 'warning' : 'info')}">
                    <h5><i class="fas fa-gavel me-2"></i>AI Statute of Limitations Analysis</h5>
                    <p><strong>Limitation Period:</strong> ${lp.text || 'See details below'}</p>
                    <p><strong>Calculated Deadline:</strong> <span class="fs-5">${a.calculated_deadline}</span></p>
                    <p><strong>Days Remaining:</strong> <span class="badge bg-${a.is_critical ? 'danger' : 'primary'} fs-6">${a.days_remaining} days</span></p>
                    <p><strong>Risk Assessment:</strong> <span class="badge bg-${a.risk_assessment === 'critical' ? 'danger' : (a.risk_assessment === 'high' ? 'warning' : 'secondary')}">${a.risk_assessment?.toUpperCase() || 'N/A'}</span></p>
                    <p><small><i class="fas fa-book me-1"></i>${lp.statutory_reference || ''}</small></p>
                </div>`;

            if (a.discovery_rule) {
                html += `
                <div class="card mb-3">
                    <div class="card-header"><i class="fas fa-search me-2"></i>Discovery Rule</div>
                    <div class="card-body">
                        <p><strong>Applies:</strong> ${a.discovery_rule.applies ? 'Yes' : 'No'}</p>
                        <p>${a.discovery_rule.explanation || ''}</p>
                    </div>
                </div>`;
            }

            if (a.tolling_provisions && a.tolling_provisions.length > 0) {
                html += `
                <div class="card mb-3">
                    <div class="card-header"><i class="fas fa-pause-circle me-2"></i>Tolling Provisions</div>
                    <ul class="list-group list-group-flush">
                        ${a.tolling_provisions.map(t => `<li class="list-group-item"><strong>${t.provision}:</strong> ${t.description}</li>`).join('')}
                    </ul>
                </div>`;
            }

            if (a.exceptions && a.exceptions.length > 0) {
                html += `
                <div class="card mb-3">
                    <div class="card-header"><i class="fas fa-exclamation-triangle me-2"></i>Exceptions</div>
                    <ul class="list-group list-group-flush">
                        ${a.exceptions.map(e => `<li class="list-group-item"><strong>${e.exception}:</strong> ${e.description}</li>`).join('')}
                    </ul>
                </div>`;
            }

            if (a.related_deadlines && a.related_deadlines.length > 0) {
                html += `
                <div class="card mb-3">
                    <div class="card-header"><i class="fas fa-calendar-alt me-2"></i>Related Deadlines</div>
                    <ul class="list-group list-group-flush">
                        ${a.related_deadlines.map(d => `<li class="list-group-item"><strong>${d.deadline}</strong> (${d.timing}): ${d.description}</li>`).join('')}
                    </ul>
                </div>`;
            }

            if (a.recommendations && a.recommendations.length > 0) {
                html += `
                <div class="card mb-3">
                    <div class="card-header"><i class="fas fa-lightbulb me-2"></i>Recommendations</div>
                    <ul class="list-group list-group-flush">
                        ${a.recommendations.map(r => `<li class="list-group-item"><i class="fas fa-check text-success me-2"></i>${r}</li>`).join('')}
                    </ul>
                </div>`;
            }

            if (a.disclaimer) {
                html += `<div class="alert alert-secondary mt-3"><small><i class="fas fa-info-circle me-1"></i>${a.disclaimer}</small></div>`;
            }

            html += `<small class="text-muted">Analysis completed in ${result.processingTime}ms</small>`;

            contentDiv.innerHTML = html;
        } else if (result.error) {
            contentDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
        } else {
            contentDiv.innerHTML = '<div class="alert alert-warning">No SOL data found for this jurisdiction/case type.</div>';
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-calculator me-1"></i>Calculate';
    }
});

// Deadline Extractor
document.getElementById('extractForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const text = document.querySelector('[name=document_text]').value;
    if (!text.trim()) return;

    const btn = this.querySelector('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Extracting...';

    try {
        const res = await fetch('/api/ai-calendar/extract-deadlines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ document_text: text })
        });
        const result = await res.json();
        if (result.success) {
            alert(`Found ${result.suggestions.length} deadlines!`);
            location.reload();
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-robot me-1"></i>Extract Deadlines';
    }
});

// Accept/Reject
document.querySelectorAll('.accept-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const id = this.dataset.id;
        try {
            await fetch(`/api/ai-calendar/suggestions/${id}/accept`, { method: 'POST' });
            location.reload();
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
});

document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const id = this.dataset.id;
        try {
            await fetch(`/api/ai-calendar/suggestions/${id}/reject`, { method: 'POST' });
            location.reload();
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
});
</script>
<%- include('../partials/footer') %>
</body>
</html>
