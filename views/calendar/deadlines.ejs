<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'calendar' }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-exclamation-circle me-2"></i>Deadlines</h2>
            <p class="text-muted mb-0">Track important dates and deadlines</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeadlineModal">
            <i class="fas fa-plus me-1"></i>Add Deadline
        </button>
    </div>

    <div class="row">
        <% ['overdue', 'urgent', 'warning', 'normal'].forEach(function(urgency) {
            var items = deadlines.filter(function(d) { return d.urgency === urgency; });
            if (items.length > 0) { %>
            <div class="col-12 mb-4">
                <h5 class="text-<%= urgency === 'overdue' ? 'danger' : urgency === 'urgent' ? 'warning' : urgency === 'warning' ? 'info' : 'secondary' %>">
                    <%= urgency.charAt(0).toUpperCase() + urgency.slice(1) %> (<%= items.length %>)
                </h5>
                <div class="list-group">
                    <% items.forEach(function(d) { %>
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center clickable-item" style="cursor:pointer;" data-id="<%= d.id %>">
                        <div>
                            <h6 class="mb-1"><%= d.title %></h6>
                            <small class="text-muted"><%= d.case_title || 'No case' %> | <%= d.deadline_type %></small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-<%= urgency === 'overdue' ? 'danger' : urgency === 'urgent' ? 'warning' : 'info' %> mb-1">
                                <%= d.daysUntil < 0 ? Math.abs(d.daysUntil) + ' days overdue' : d.daysUntil + ' days' %>
                            </span><br>
                            <small><%= new Date(d.due_date).toLocaleDateString() %></small>
                            <div class="btn-group btn-group-sm mt-1">
                                <% if (d.status === 'pending') { %>
                                <button class="btn btn-outline-success btn-complete" data-id="<%= d.id %>" title="Complete"><i class="fas fa-check"></i></button>
                                <% } %>
                                <button class="btn btn-outline-secondary btn-edit" data-id="<%= d.id %>" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-outline-danger btn-delete" data-id="<%= d.id %>" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>
        <% } }); %>

        <% if (deadlines.length === 0) { %>
        <div class="col-12 text-center py-5">
            <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
            <h5>No Deadlines</h5>
            <p class="text-muted">Add your first deadline to track important dates.</p>
        </div>
        <% } %>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="addDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Deadline</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" id="dlTitle" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Case</label>
                    <select id="dlCase" class="form-select">
                        <option value="">Select Case</option>
                        <% cases.forEach(function(c) { %>
                        <option value="<%= c.id %>"><%= c.title %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Due Date *</label>
                        <input type="date" id="dlDate" class="form-control" required>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Type</label>
                        <select id="dlType" class="form-select">
                            <option value="filing">Filing</option>
                            <option value="discovery">Discovery</option>
                            <option value="response">Response</option>
                            <option value="statute_of_limitations">SOL</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="dlDesc" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveDeadline">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-circle me-2"></i>Deadline Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deadlineDetails"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="btnDeleteDeadline"><i class="fas fa-trash me-1"></i>Delete</button>
                <button type="button" class="btn btn-outline-success" id="btnCompleteDeadline"><i class="fas fa-check me-1"></i>Complete</button>
                <button type="button" class="btn btn-outline-primary" id="btnEditDeadline"><i class="fas fa-edit me-1"></i>Edit</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
var currentDeadlineId = null;
var currentDeadlineStatus = null;

document.querySelectorAll('.clickable-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
        if (e.target.closest('.btn-group') || e.target.closest('button')) return;
        if (this.dataset.id) viewDeadline(this.dataset.id);
    });
});

document.querySelectorAll('.btn-complete').forEach(function(btn) {
    btn.addEventListener('click', function(e) { e.stopPropagation(); completeDeadline(this.dataset.id); });
});

document.querySelectorAll('.btn-edit').forEach(function(btn) {
    btn.addEventListener('click', function(e) { e.stopPropagation(); editDeadline(this.dataset.id); });
});

document.querySelectorAll('.btn-delete').forEach(function(btn) {
    btn.addEventListener('click', function(e) { e.stopPropagation(); deleteDeadline(this.dataset.id); });
});

function viewDeadline(id) {
    currentDeadlineId = id;
    fetch('/api/deadlines/' + id)
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.deadline) {
            var d = data.deadline;
            currentDeadlineStatus = d.status;
            var typeLabels = { 'filing': 'Filing Deadline', 'discovery': 'Discovery', 'response': 'Response Due', 'statute_of_limitations': 'Statute of Limitations' };
            var statusColors = { 'pending': 'warning', 'completed': 'success', 'missed': 'danger' };
            var dueDate = new Date(d.due_date);
            var today = new Date(); today.setHours(0, 0, 0, 0);
            var daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            var urgencyText = '', urgencyClass = '';
            if (d.status === 'completed') { urgencyText = 'Completed'; urgencyClass = 'success'; }
            else if (daysUntil < 0) { urgencyText = Math.abs(daysUntil) + ' days overdue'; urgencyClass = 'danger'; }
            else if (daysUntil === 0) { urgencyText = 'Due today!'; urgencyClass = 'danger'; }
            else if (daysUntil <= 7) { urgencyText = daysUntil + ' days remaining'; urgencyClass = 'warning'; }
            else { urgencyText = daysUntil + ' days remaining'; urgencyClass = 'info'; }

            var html = '<h5 class="mb-3">' + d.title + '</h5>' +
                '<div class="alert alert-' + urgencyClass + ' text-center mb-3"><i class="fas fa-clock me-2"></i><strong>' + urgencyText + '</strong></div>' +
                '<table class="table table-borderless">' +
                '<tr><th width="120"><i class="fas fa-calendar text-muted me-2"></i>Due Date:</th><td><strong>' + dueDate.toLocaleDateString() + '</strong></td></tr>' +
                '<tr><th><i class="fas fa-tag text-muted me-2"></i>Type:</th><td><span class="badge bg-secondary">' + (typeLabels[d.deadline_type] || d.deadline_type) + '</span></td></tr>' +
                '<tr><th><i class="fas fa-check-circle text-muted me-2"></i>Status:</th><td><span class="badge bg-' + (statusColors[d.status] || 'secondary') + '">' + d.status + '</span></td></tr>' +
                '<tr><th><i class="fas fa-briefcase text-muted me-2"></i>Case:</th><td>' + (d.case_title ? '<a href="/cases/' + d.case_id + '">' + d.case_title + '</a>' : '<span class="text-muted">Not linked</span>') + '</td></tr>';
            if (d.is_critical) html += '<tr><th><i class="fas fa-exclamation-triangle text-muted me-2"></i>Critical:</th><td><span class="badge bg-danger">Yes - Critical Deadline</span></td></tr>';
            html += '</table>';
            if (d.description) html += '<div class="mt-3"><strong><i class="fas fa-align-left me-2"></i>Description:</strong><p class="mt-2 p-3 bg-light rounded">' + d.description + '</p></div>';
            document.getElementById('deadlineDetails').innerHTML = html;
            document.getElementById('btnCompleteDeadline').style.display = d.status === 'completed' ? 'none' : 'inline-block';
            new bootstrap.Modal(document.getElementById('viewDeadlineModal')).show();
        }
    });
}

document.getElementById('btnEditDeadline').onclick = function() { bootstrap.Modal.getInstance(document.getElementById('viewDeadlineModal')).hide(); editDeadline(currentDeadlineId); };
document.getElementById('btnDeleteDeadline').onclick = function() { bootstrap.Modal.getInstance(document.getElementById('viewDeadlineModal')).hide(); deleteDeadline(currentDeadlineId); };
document.getElementById('btnCompleteDeadline').onclick = function() { bootstrap.Modal.getInstance(document.getElementById('viewDeadlineModal')).hide(); completeDeadline(currentDeadlineId); };

function editDeadline(id) {
    fetch('/api/deadlines/' + id)
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.deadline) {
            var d = data.deadline;
            document.getElementById('dlTitle').value = d.title;
            document.getElementById('dlCase').value = d.case_id || '';
            document.getElementById('dlDate').value = d.due_date ? d.due_date.split('T')[0] : '';
            document.getElementById('dlType').value = d.deadline_type || 'filing';
            document.getElementById('dlDesc').value = d.description || '';
            document.getElementById('addDeadlineModal').dataset.editId = id;
            document.querySelector('#addDeadlineModal .modal-title').textContent = 'Edit Deadline';
            new bootstrap.Modal(document.getElementById('addDeadlineModal')).show();
        }
    });
}

function saveDeadline() {
    var editId = document.getElementById('addDeadlineModal').dataset.editId;
    var url = editId ? '/api/deadlines/' + editId : '/api/deadlines';
    var method = editId ? 'PUT' : 'POST';
    fetch(url, {
        method: method, headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: document.getElementById('dlTitle').value, case_id: document.getElementById('dlCase').value || null, due_date: document.getElementById('dlDate').value, deadline_type: document.getElementById('dlType').value, description: document.getElementById('dlDesc').value })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            location.reload();
        } else {
            alert('Error saving deadline: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(function(err) {
        alert('Failed to save deadline');
        console.error(err);
    });
}

function completeDeadline(id) {
    if (confirm('Mark this deadline as completed?')) {
        fetch('/api/deadlines/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'completed' }) })
        .then(function() { location.reload(); });
    }
}

function deleteDeadline(id) {
    if (confirm('Delete this deadline?')) {
        fetch('/api/deadlines/' + id, { method: 'DELETE' })
        .then(function(r) { return r.json(); })
        .then(function(data) { if (data.success) location.reload(); else alert('Error: ' + (data.error || 'Failed')); });
    }
}

document.getElementById('addDeadlineModal').addEventListener('hidden.bs.modal', function() {
    delete this.dataset.editId;
    document.querySelector('#addDeadlineModal .modal-title').textContent = 'Add Deadline';
    document.getElementById('dlTitle').value = '';
    document.getElementById('dlCase').value = '';
    document.getElementById('dlDate').value = '';
    document.getElementById('dlType').value = 'filing';
    document.getElementById('dlDesc').value = '';
});

document.getElementById('btnSaveDeadline').addEventListener('click', saveDeadline);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
</body>
</html>
