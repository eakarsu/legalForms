<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'calendar' }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-calendar-alt me-2"></i>Calendar</h2>
            <p class="text-muted mb-0">View and manage events</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="fas fa-plus me-1"></i>Add Event
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" id="evtTitle" name="title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Type</label>
                    <select id="evtType" class="form-select">
                        <option value="meeting">Meeting</option>
                        <option value="hearing">Hearing</option>
                        <option value="deadline">Deadline</option>
                        <option value="deposition">Deposition</option>
                        <option value="mediation">Mediation</option>
                        <option value="task">Task</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Start</label>
                        <input type="datetime-local" id="evtStart" name="start_date" class="form-control">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">End</label>
                        <input type="datetime-local" id="evtEnd" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Case</label>
                    <select id="evtCase" class="form-select">
                        <option value="">No Case</option>
                        <% cases.forEach(c => { %>
                        <option value="<%= c.id %>"><%= c.title %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" id="evtLocation" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="evtDesc" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveEvent">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- View Event Modal -->
<div class="modal fade" id="viewEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="btnDeleteEvent"><i class="fas fa-trash me-1"></i>Delete</button>
                <button type="button" class="btn btn-outline-primary" id="btnEditEvent"><i class="fas fa-edit me-1"></i>Edit</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
var currentEventId = null;
var calendarInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    calendarInstance = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
        events: '/api/calendar/events',
        eventClick: function(info) {
            viewEvent(info.event);
        },
        dateClick: function(info) {
            clearEventForm();
            document.getElementById('evtStart').value = info.dateStr + 'T09:00';
            document.getElementById('evtEnd').value = info.dateStr + 'T10:00';
            new bootstrap.Modal(document.getElementById('addEventModal')).show();
        }
    });
    calendarInstance.render();
});

function viewEvent(event) {
    currentEventId = event.id;
    var props = event.extendedProps || {};
    var startDate = event.start ? new Date(event.start) : null;
    var endDate = event.end ? new Date(event.end) : null;
    var typeColors = { 'meeting': 'primary', 'hearing': 'danger', 'deadline': 'warning', 'deposition': 'info', 'mediation': 'success', 'task': 'secondary' };
    var typeColor = typeColors[props.event_type] || 'primary';
    var html = '<div class="row"><div class="col-md-8"><h4 class="mb-3">' + event.title + '</h4>' +
        '<table class="table table-borderless">' +
        '<tr><th width="140"><i class="fas fa-tag text-muted me-2"></i>Type:</th><td><span class="badge bg-' + typeColor + '">' + (props.event_type || 'Event').charAt(0).toUpperCase() + (props.event_type || 'Event').slice(1) + '</span></td></tr>' +
        '<tr><th><i class="fas fa-calendar text-muted me-2"></i>Start:</th><td>' + (startDate ? startDate.toLocaleString() : 'N/A') + '</td></tr>' +
        '<tr><th><i class="fas fa-calendar-check text-muted me-2"></i>End:</th><td>' + (endDate ? endDate.toLocaleString() : 'N/A') + '</td></tr>';
    if (props.location) html += '<tr><th><i class="fas fa-map-marker-alt text-muted me-2"></i>Location:</th><td>' + props.location + '</td></tr>';
    if (props.case_title) html += '<tr><th><i class="fas fa-briefcase text-muted me-2"></i>Case:</th><td><a href="/cases/' + props.case_id + '">' + props.case_title + '</a></td></tr>';
    html += '</table>';
    if (props.description) html += '<div class="mt-3"><strong><i class="fas fa-align-left me-2"></i>Description:</strong><p class="mt-2 text-muted">' + props.description + '</p></div>';
    html += '</div><div class="col-md-4"><div class="card bg-light"><div class="card-body text-center">' +
        '<div class="display-4 text-' + typeColor + '"><i class="fas fa-' + getEventIcon(props.event_type) + '"></i></div>' +
        '<h6 class="mt-2">' + (props.event_type || 'Event').charAt(0).toUpperCase() + (props.event_type || 'Event').slice(1) + '</h6></div></div></div></div>';
    document.getElementById('eventDetails').innerHTML = html;
    new bootstrap.Modal(document.getElementById('viewEventModal')).show();
}

function getEventIcon(type) {
    var icons = { 'meeting': 'users', 'hearing': 'gavel', 'deadline': 'exclamation-circle', 'deposition': 'microphone', 'mediation': 'handshake', 'task': 'tasks' };
    return icons[type] || 'calendar';
}

document.getElementById('btnEditEvent').onclick = function() {
    bootstrap.Modal.getInstance(document.getElementById('viewEventModal')).hide();
    fetch('/api/calendar/events/' + currentEventId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.event) {
            var e = data.event;
            document.getElementById('evtTitle').value = e.title;
            document.getElementById('evtType').value = e.event_type || 'meeting';
            document.getElementById('evtStart').value = e.start_time ? e.start_time.slice(0, 16) : '';
            document.getElementById('evtEnd').value = e.end_time ? e.end_time.slice(0, 16) : '';
            document.getElementById('evtCase').value = e.case_id || '';
            document.getElementById('evtLocation').value = e.location || '';
            document.getElementById('evtDesc').value = e.description || '';
            document.getElementById('addEventModal').dataset.editId = currentEventId;
            document.querySelector('#addEventModal .modal-title').textContent = 'Edit Event';
            new bootstrap.Modal(document.getElementById('addEventModal')).show();
        }
    });
};

document.getElementById('btnDeleteEvent').onclick = function() {
    if (confirm('Delete this event?')) {
        fetch('/api/calendar/events/' + currentEventId, { method: 'DELETE' })
        .then(function() { location.reload(); });
    }
};

function clearEventForm() {
    document.getElementById('evtTitle').value = '';
    document.getElementById('evtType').value = 'meeting';
    document.getElementById('evtStart').value = '';
    document.getElementById('evtEnd').value = '';
    document.getElementById('evtCase').value = '';
    document.getElementById('evtLocation').value = '';
    document.getElementById('evtDesc').value = '';
    delete document.getElementById('addEventModal').dataset.editId;
    document.querySelector('#addEventModal .modal-title').textContent = 'Add Event';
}

function saveEvent() {
    var editId = document.getElementById('addEventModal').dataset.editId;
    var url = editId ? '/api/calendar/events/' + editId : '/api/calendar/events';
    var method = editId ? 'PUT' : 'POST';
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: document.getElementById('evtTitle').value,
            event_type: document.getElementById('evtType').value,
            start_time: document.getElementById('evtStart').value,
            end_time: document.getElementById('evtEnd').value,
            case_id: document.getElementById('evtCase').value || null,
            location: document.getElementById('evtLocation').value,
            description: document.getElementById('evtDesc').value
        })
    }).then(function() { location.reload(); });
}

document.getElementById('btnSaveEvent').addEventListener('click', saveEvent);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
</body>
</html>
