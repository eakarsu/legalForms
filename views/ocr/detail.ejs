<%- include('../base-pm', {
    title: job.file_name + ' - OCR Results',
    description: 'OCR extraction results'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/ocr">Document OCR</a></li>
                    <li class="breadcrumb-item active"><%= job.file_name %></li>
                </ol>
            </nav>
            <h2><i class="fas fa-file-image me-2"></i><%= job.file_name %></h2>
            <p class="text-muted mb-0">
                Processed: <%= new Date(job.created_at).toLocaleString() %> |
                <span class="badge bg-<%= job.status === 'completed' ? 'success' : job.status === 'processing' ? 'warning' : 'danger' %>"><%= job.status %></span>
            </p>
        </div>
        <div>
            <button class="btn btn-primary me-2" onclick="copyAllText()">
                <i class="fas fa-copy me-1"></i>Copy All Text
            </button>
            <button class="btn btn-outline-success me-2" onclick="saveAsDocument()">
                <i class="fas fa-save me-1"></i>Save as Document
            </button>
            <button class="btn btn-outline-secondary" onclick="downloadText()">
                <i class="fas fa-download me-1"></i>Download TXT
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3><%= job.page_count || 0 %></h3>
                    <small>Pages</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3><%= job.pages_processed || 0 %></h3>
                    <small>Processed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3><%= Math.round((job.confidence || 0) * 100) %>%</h3>
                    <small>Avg Confidence</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3><%= (typeof entities !== 'undefined' ? entities.length : 0) %></h3>
                    <small>Entities Found</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Extracted Text -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Extracted Text</h5>
                    <% if (typeof pages !== 'undefined' && pages.length > 1) { %>
                    <select class="form-select form-select-sm w-auto" id="pageSelect">
                        <option value="all">All Pages</option>
                        <% pages.forEach((p, i) => { %>
                        <option value="<%= i %>">Page <%= p.page_number %></option>
                        <% }) %>
                    </select>
                    <% } %>
                </div>
                <div class="card-body">
                    <div id="textContent" class="ocr-text-content">
                        <% if (typeof pages !== 'undefined' && pages.length > 0) { %>
                            <% pages.forEach(page => { %>
                            <div class="page-content" data-page="<%= page.page_number - 1 %>">
                                <h6 class="text-muted mb-2">Page <%= page.page_number %></h6>
                                <pre class="mb-4"><%= page.extracted_text || 'No text extracted' %></pre>
                            </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-muted">No text extracted yet</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Search in Document -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Search in Document</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search for text...">
                        <button class="btn btn-primary" onclick="searchText()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Extracted Entities -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Extracted Entities</h5>
                </div>
                <div class="card-body">
                    <% if (typeof entities !== 'undefined' && entities.length > 0) { %>
                    <div class="entity-list">
                        <%
                        const entityTypes = {};
                        entities.forEach(e => {
                            if (!entityTypes[e.entity_type]) entityTypes[e.entity_type] = [];
                            entityTypes[e.entity_type].push(e);
                        });
                        %>
                        <% Object.entries(entityTypes).forEach(([type, items]) => { %>
                        <h6 class="text-uppercase text-muted mb-2"><%= type.replace('_', ' ') %></h6>
                        <ul class="list-unstyled mb-3">
                            <% items.slice(0, 5).forEach(item => { %>
                            <li class="mb-1">
                                <i class="fas fa-<%= type === 'email' ? 'envelope' : type === 'phone' ? 'phone' : type === 'date' ? 'calendar' : type === 'money' ? 'dollar-sign' : 'tag' %> me-2 text-muted"></i>
                                <%= item.entity_value %>
                            </li>
                            <% }) %>
                            <% if (items.length > 5) { %>
                            <li class="text-muted">... and <%= items.length - 5 %> more</li>
                            <% } %>
                        </ul>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="text-muted mb-0">No entities extracted</p>
                    <% } %>
                </div>
            </div>

            <!-- Job Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Details</h5>
                </div>
                <div class="card-body">
                    <p><strong>File Type:</strong> <%= job.file_type.toUpperCase() %></p>
                    <p><strong>Language:</strong> <%= job.language || 'English' %></p>
                    <p><strong>File Size:</strong> <%= Math.round((job.file_size || 0) / 1024) %> KB</p>
                    <% if (job.client_id) { %>
                    <p><strong>Client:</strong> <%= job.first_name %> <%= job.last_name %></p>
                    <% } %>
                    <% if (job.case_id) { %>
                    <p><strong>Case:</strong> <%= job.case_title %></p>
                    <% } %>
                </div>
            </div>

            <!-- Job Info -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Job Info</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>File:</strong> <%= job.file_name %></p>
                    <p class="mb-2"><strong>Pages:</strong> <%= job.page_count || 1 %></p>
                    <p class="mb-0"><strong>Status:</strong> <span class="badge bg-<%= job.status === 'completed' ? 'success' : job.status === 'failed' ? 'danger' : 'warning' %>"><%= job.status %></span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.ocr-text-content {
    max-height: 600px;
    overflow-y: auto;
}
.ocr-text-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
}
.highlight {
    background-color: yellow;
    padding: 2px;
}
</style>

<script>
function copyAllText() {
    const text = Array.from(document.querySelectorAll('.page-content pre'))
        .map(pre => pre.textContent)
        .join('\n\n--- Page Break ---\n\n');

    navigator.clipboard.writeText(text).then(() => {
        alert('Text copied to clipboard!');
    });
}

function downloadText() {
    const text = Array.from(document.querySelectorAll('.page-content pre'))
        .map(pre => pre.textContent)
        .join('\n\n--- Page Break ---\n\n');

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '<%= job.file_name.replace(/\.[^/.]+$/, '') %>.txt';
    a.click();
}

async function saveAsDocument() {
    try {
        const response = await fetch('/api/ocr/<%= job.id %>/save-document', {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            alert('Document saved successfully! You can find it in your document history.');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Save failed');
    }
}

function searchText() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const resultsDiv = document.getElementById('searchResults');

    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }

    const pages = document.querySelectorAll('.page-content');
    let results = [];

    pages.forEach((page, i) => {
        const text = page.querySelector('pre').textContent;
        const lowerText = text.toLowerCase();
        let pos = 0;
        let count = 0;

        while ((pos = lowerText.indexOf(query, pos)) !== -1) {
            count++;
            const start = Math.max(0, pos - 50);
            const end = Math.min(text.length, pos + query.length + 50);
            const snippet = '...' + text.substring(start, end).replace(new RegExp(query, 'gi'), '<mark>$&</mark>') + '...';
            results.push({ page: i + 1, snippet });
            pos++;
        }
    });

    if (results.length > 0) {
        resultsDiv.innerHTML = '<p class="mb-2"><strong>' + results.length + ' matches found</strong></p>' +
            results.slice(0, 10).map(r => '<div class="mb-2 p-2 bg-light rounded"><small class="text-muted">Page ' + r.page + ':</small><br>' + r.snippet + '</div>').join('');
    } else {
        resultsDiv.innerHTML = '<p class="text-muted">No matches found</p>';
    }
}

// Page filter
document.getElementById('pageSelect')?.addEventListener('change', function() {
    const value = this.value;
    document.querySelectorAll('.page-content').forEach((page, i) => {
        page.style.display = (value === 'all' || parseInt(value) === i) ? '' : 'none';
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
