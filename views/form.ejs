<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'Legal Forms Generator' %></title>
    <meta name="description" content="Generate professional legal documents quickly and accurately using AI-powered templates.">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/enhanced-features.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <div class="brand-icon me-2">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <span class="brand-text">LegalForms<span class="text-primary">AI</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/#form-types">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/faq">FAQ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
        <div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active"><%= formConfig.name %></li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1><%= formConfig.name %></h1>
        <p class="lead"><%= formConfig.description %></p>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Document Information</h5>
            </div>
            <div class="card-body">
                <form id="documentForm">
                    <!-- Natural Language Input -->
                    <div class="mb-4">
                        <label for="naturalLanguageInput" class="form-label">Describe Your Legal Needs</label>
                        <div class="input-group">
                            <textarea class="form-control" id="naturalLanguageInput" rows="3"
                                placeholder="Example: I need to form an LLC for my consulting business in California..."></textarea>
                            <button class="btn btn-outline-danger" type="button" id="voiceInputBtn" title="Click to start voice input (or press Ctrl+Shift+V)">
                                <i class="fas fa-microphone" id="voiceIcon"></i> <span id="voiceBtnText">Voice</span>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="parseNLBtn">
                                <i class="fas fa-magic"></i> Parse
                            </button>
                        </div>
                        <small class="form-text text-muted">Type or speak to describe what you need in plain English, and we'll help fill out the form.</small>

                        <!-- Example Buttons -->
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="example1Btn">
                                <i class="fas fa-lightbulb"></i> Example 1
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="example2Btn">
                                <i class="fas fa-lightbulb"></i> Example 2
                            </button>
                        </div>

                        <!-- Voice Status Indicator -->
                        <div id="voiceStatus" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0 d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span id="voiceStatusText">Listening...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Template Recommendations -->
                    <div id="templateRecommendations" class="mb-4" style="display: none;">
                        <label class="form-label">Recommended Templates</label>
                        <div id="recommendationsList" class="list-group">
                            <!-- Recommendations will be loaded here -->
                        </div>
                    </div>

                    <!-- Form Type Selection -->
                    <div class="mb-4">
                        <label for="specificFormType" class="form-label">Select Specific Document Type *</label>
                        <select class="form-select" id="specificFormType" name="specificFormType" required>
                            <option value="">Choose a specific document type...</option>
                        </select>
                        <small class="form-text text-muted">Select the exact type of document you need to generate.</small>
                    </div>

                    <!-- Template vs AI Choice -->
                    <div class="mb-4" id="generationMethodChoice" style="display: none;">
                        <label class="form-label">Generation Method *</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100 generation-option" data-method="template">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-contract fa-2x text-primary mb-2"></i>
                                        <h6>Professional Template</h6>
                                        <p class="small text-muted">Use professionally drafted legal templates with your data</p>
                                        <div class="badge bg-success">Recommended</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 generation-option" data-method="ai">
                                    <div class="card-body text-center">
                                        <i class="fas fa-robot fa-2x text-info mb-2"></i>
                                        <h6>AI Generated</h6>
                                        <p class="small text-muted">Generate custom documents using AI based on your specific needs</p>
                                        <div class="badge bg-info">Custom</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="generationMethod" name="generationMethod" required>
                        <small class="form-text text-muted">Choose how you want your document to be created.</small>
                    </div>
                    
                    <!-- Document Format Selection -->
                    <div class="mb-4">
                        <label for="documentFormat" class="form-label">Select Document Format *</label>
                        <select class="form-select" id="documentFormat" name="documentFormat" required>
                            <option value="pdf">PDF Document (.pdf)</option>
                            <option value="docx">Microsoft Word (.docx)</option>
                            <option value="txt">Text Document (.txt)</option>
                        </select>
                        <small class="form-text text-muted">Choose the format for your generated document.</small>
                    </div>
                    
                    <div id="formFields">
                        <!-- Dynamic form fields will be loaded here -->
                    </div>

                    <!-- Compliance Issues Display -->
                    <div id="complianceIssues" class="mb-4" style="display: none;">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Compliance Issues</h6>
                            <ul id="complianceIssuesList"></ul>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-file-alt me-2"></i>
                                Generate Document
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>
                                Reset Form
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Form Instructions</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Fill out all required fields</li>
                    <li><i class="fas fa-check text-success me-2"></i>Provide accurate information</li>
                    <li><i class="fas fa-check text-success me-2"></i>Review generated document</li>
                    <li><i class="fas fa-check text-success me-2"></i>Consult with attorney if needed</li>
                </ul>
                
                <div class="alert alert-warning mt-3">
                    <small>
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Always have legal documents reviewed by a qualified attorney before use.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Generating Document...</h5>
                <p class="text-muted">Please wait while we create your legal document.</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generated Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Document Preview:</strong> This is a text preview of your document. The downloaded file will be formatted according to your selected format.
                </div>
                
                <!-- Document Review Results -->
                <div id="reviewResults" class="mb-3" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-search"></i> Automated Review</h6>
                        </div>
                        <div class="card-body">
                            <div id="reviewScore" class="mb-2"></div>
                            <div id="reviewIssues"></div>
                            <div id="reviewSuggestions"></div>
                        </div>
                    </div>
                </div>
                
                <div id="documentContent" class="generated-document"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download me-2"></i>Download Document
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="regenerateBtn">
                        <i class="fas fa-redo me-2"></i>Generate Different Format
                    </button>
                    <button type="button" class="btn btn-outline-success" id="esignBtn" style="display: none;">
                        <i class="fas fa-signature me-2"></i>Send for E-Signature
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="brand-icon me-2 text-white">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <span class="brand-text text-white">LegalForms<span class="text-primary">AI</span></span>
                    </div>
                    <p class="text-muted">Professional legal document generation powered by advanced AI technology.</p>
                </div>
                <div class="col-lg-8 mb-4">
                    <h6 class="text-white mb-3">Important Legal Disclaimer</h6>
                    <p class="text-muted small">
                        This tool generates legal document templates for informational purposes only. 
                        All generated documents should be reviewed by a qualified attorney before use. 
                        Laws vary by jurisdiction, and professional legal advice is recommended for all legal matters.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
    let currentFilename = null;
    let currentDocumentId = null;
    let socket = null;

    // Initialize Socket.io for real-time features
    function initializeSocket() {
        socket = io();
        
        socket.on('validation_result', function(data) {
            displayFieldValidation(data.field_name, data.issues, data.suggestions);
        });
        
        socket.on('validation_error', function(data) {
            console.error('Validation error for field:', data.field_name, data.error);
        });
    }

    // Load form types when page loads
    $(document).ready(function() {
        console.log('Document ready, jQuery version:', $.fn.jquery);
        console.log('Page loaded, loading form types...');
        
        // Initialize real-time features
        initializeSocket();
        
        // Test API connectivity first
        $.get('/api/test')
            .done(function(response) {
                console.log('API test successful:', response);
                loadSpecificFormTypes();
                loadTemplateRecommendations();
            })
            .fail(function(xhr, status, error) {
                console.error('API test failed:', error);
                $('#specificFormType').html('<option value="">API connection failed</option>');
            });
    });

    function loadSpecificFormTypes() {
        const formType = '<%= formType %>';
        console.log('Loading form types for:', formType);
        
        // Add error handling and timeout
        $.ajax({
            url: `/api/form-types/${formType}`,
            method: 'GET',
            timeout: 10000,
            dataType: 'json',
            success: function(types) {
                console.log('Received form types:', types);
                console.log('Types is array:', Array.isArray(types));
                console.log('Types length:', types ? types.length : 'undefined');
                renderSpecificFormTypes(types);
            },
            error: function(xhr, status, error) {
                console.error('Error loading form types:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                $('#specificFormType').html('<option value="">Error loading form types</option>');
            }
        });
    }

    function renderSpecificFormTypes(types) {
        console.log('Rendering types:', types);
        let html = '<option value="">Choose a specific document type...</option>';
        
        if (types && Array.isArray(types) && types.length > 0) {
            types.forEach(function(type) {
                console.log('Adding type:', type);
                html += `<option value="${type.value}">${type.label}</option>`;
            });
        } else {
            console.log('No types available or invalid data:', types);
            html += '<option value="">No document types available</option>';
        }
        
        console.log('Setting dropdown HTML:', html);
        $('#specificFormType').html(html);
    }

    // Handle specific form type selection
    $(document).on('change', '#specificFormType', function() {
        const specificType = $(this).val();
        if (specificType) {
            $('#generationMethodChoice').show();
            // Don't load form fields yet - wait for generation method selection
        } else {
            $('#formFields').html('');
            $('#generationMethodChoice').hide();
        }
    });

    // Handle generation method selection
    $(document).on('click', '.generation-option', function() {
        $('.generation-option').removeClass('border-primary bg-light');
        $(this).addClass('border-primary bg-light');
        
        const method = $(this).data('method');
        $('#generationMethod').val(method);
        
        const specificType = $('#specificFormType').val();
        if (specificType) {
            loadFormFields(specificType, method);
        }
    });

    function loadFormFields(specificType) {
        const formType = '<%= formType %>';
        
        $.get(`/api/form-fields/${formType}/${specificType}`)
            .done(function(fields) {
                renderFormFields(fields);
            })
            .fail(function() {
                $('#formFields').html('<div class="alert alert-danger">Error loading form fields</div>');
            });
    }

    function renderFormFields(fields) {
        let html = '';
        
        fields.forEach(function(field) {
            html += '<div class="mb-3">';
            html += `<label for="${field.name}" class="form-label">`;
            html += field.label;
            if (field.required) {
                html += ' <span class="text-danger">*</span>';
            }
            html += '</label>';
            
            if (field.type === 'select') {
                html += `<select class="form-select" id="${field.name}" name="${field.name}"`;
                if (field.required) html += ' required';
                html += '>';
                html += '<option value="">Select an option</option>';
                field.options.forEach(function(option) {
                    html += `<option value="${option}">${option}</option>`;
                });
                html += '</select>';
            } else if (field.type === 'textarea') {
                html += `<textarea class="form-control" id="${field.name}" name="${field.name}" rows="3"`;
                if (field.required) html += ' required';
                html += '></textarea>';
            } else {
                html += `<input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}"`;
                if (field.required) html += ' required';
                html += '>';
            }
            
            html += '</div>';
        });
        
        $('#formFields').html(html);
    }

    function resetForm() {
        document.getElementById('documentForm').reset();
        $('#formFields').html('');
    }

    // Handle form submission
    $(document).on('submit', '#documentForm', function(e) {
        e.preventDefault();
        
        // Check if specific form type is selected
        const specificType = $('#specificFormType').val();
        if (!specificType) {
            alert('Please select a specific document type first.');
            return;
        }
        
        // Get selected format
        const format = $('#documentFormat').val() || 'pdf';
        
        // Collect form data
        const formData = {};
        $(this).find('input, select, textarea').each(function() {
            if (this.name) {
                formData[this.name] = this.value;
            }
        });
        
        // Add specific form type to form data
        formData.specific_form_type = specificType;
        
        // Show loading modal with format info
        $('#loadingModal .modal-body p').text(`Please wait while we create your ${format.toUpperCase()} legal document.`);
        $('#loadingModal').modal('show');
        
        // Submit to backend
        $.ajax({
            url: '/generate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                form_type: '<%= formType %>',
                specific_type: specificType,
                form_data: formData,
                format: format
            }),
            success: function(response) {
                $('#loadingModal').modal('hide');
                
                if (response.success) {
                    $('#documentContent').text(response.document);
                    currentFilename = response.filename;
                    
                    // Update download button text based on format
                    const formatText = response.format.toUpperCase();
                    $('#downloadBtn').html(`<i class="fas fa-download me-2"></i>Download ${formatText} Document`);
                    
                    $('#resultsModal').modal('show');
                } else {
                    alert('Error generating document: ' + response.error);
                }
            },
            error: function(xhr) {
                $('#loadingModal').modal('hide');
                alert('Error generating document. Please try again.');
            }
        });
    });

    // Handle download
    $(document).on('click', '#downloadBtn', function() {
        if (currentFilename) {
            window.location.href = `/download/${currentFilename}`;
        }
    });
    
    // Handle regenerate with different format
    $(document).on('click', '#regenerateBtn', function() {
        $('#resultsModal').modal('hide');
        // Scroll back to format selection
        $('#documentFormat')[0].scrollIntoView({ behavior: 'smooth' });
        $('#documentFormat').focus();
    });

    // Natural Language Processing
    $(document).on('click', '#parseNLBtn', function() {
        const text = $('#naturalLanguageInput').val();
        if (!text.trim()) {
            alert('Please enter a description of your legal needs');
            return;
        }

        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Parsing...');

        if (window.nlpProcessor) {
            window.nlpProcessor.parseInput(text)
                .then(result => {
                    window.nlpProcessor.applyParsedData(result);
                    // Load form types for detected intent
                    if (result.intent && result.intent !== '<%= formType %>') {
                        window.location.href = `/form/${result.intent}`;
                    }
                })
                .catch(error => {
                    alert('Error parsing input: ' + error.message);
                })
                .finally(() => {
                    $('#parseNLBtn').prop('disabled', false).html('<i class="fas fa-magic"></i> Parse');
                });
        }
    });

    // Load template recommendations
    function loadTemplateRecommendations() {
        $.get(`/api/templates/recommendations/<%= formType %>`)
            .done(function(response) {
                if (response.success && response.recommendations.length > 0) {
                    displayTemplateRecommendations(response.recommendations);
                }
            })
            .catch(function(error) {
                console.error('Failed to load recommendations:', error);
            });
    }

    // Display template recommendations
    function displayTemplateRecommendations(recommendations) {
        const container = $('#recommendationsList');
        const recommendationsDiv = $('#templateRecommendations');
        
        container.empty();
        
        recommendations.forEach(function(rec, index) {
            const item = $(`
                <div class="list-group-item recommendation-item" data-specific-type="${rec.specific_type}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${getSpecificTypeLabel(rec.specific_type)}</h6>
                            <p class="mb-1 recommendation-reason">${rec.reason}</p>
                        </div>
                        <span class="badge bg-primary recommendation-score">${Math.round(rec.score * 100)}%</span>
                    </div>
                </div>
            `);
            container.append(item);
        });
        
        recommendationsDiv.show();
        
        // Handle recommendation clicks
        $('.recommendation-item').on('click', function() {
            const specificType = $(this).data('specific-type');
            $('#specificFormType').val(specificType).trigger('change');
            $(this).addClass('active').siblings().removeClass('active');
        });
    }

    // Helper function to get specific type label
    function getSpecificTypeLabel(specificType) {
        // This would ideally come from the server, but for now we'll use a simple mapping
        const labels = {
            'llc_articles': 'LLC Articles of Organization',
            'corp_articles': 'Corporation Articles of Incorporation',
            'purchase_agreement': 'Real Estate Purchase Agreement',
            'lease_agreement': 'Residential Lease Agreement',
            'divorce_petition': 'Divorce Petition',
            'last_will': 'Last Will and Testament',
            'employment_agreement': 'Employment Agreement',
            'civil_complaint': 'Civil Complaint',
            'service_agreement': 'Service Agreement'
        };
        return labels[specificType] || specificType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Setup compliance validation when form fields are loaded
    function setupComplianceValidation() {
        if (window.complianceValidator) {
            window.complianceValidator.setupFieldListeners('<%= formType %>');
        }
    }

    // Enhanced form submission with review results
    function handleGenerationSuccess(response) {
        $('#loadingModal').modal('hide');
        
        if (response.success) {
            $('#documentContent').text(response.document);
            currentFilename = response.filename;
            currentDocumentId = response.documentId;
            
            // Update download button text based on format
            const formatText = response.format.toUpperCase();
            $('#downloadBtn').html(`<i class="fas fa-download me-2"></i>Download ${formatText} Document`);
            
            // Show e-signature button if document was saved
            if (currentDocumentId) {
                $('#esignBtn').show();
            }
            
            // Display review results if available
            if (response.reviewResults) {
                displayReviewResults(response.reviewResults);
            }
            
            // Display compliance validation if available
            if (response.complianceValidation && response.complianceValidation.issues.length > 0) {
                displayComplianceResults(response.complianceValidation);
            }
            
            $('#resultsModal').modal('show');
        } else {
            alert('Error generating document: ' + response.error);
        }
    }

    // Display document review results
    function displayReviewResults(reviewResults) {
        const reviewDiv = $('#reviewResults');
        const scoreDiv = $('#reviewScore');
        const issuesDiv = $('#reviewIssues');
        const suggestionsDiv = $('#reviewSuggestions');
        
        // Display score
        const score = Math.round(reviewResults.score * 100);
        const scoreClass = score >= 80 ? 'excellent' : score >= 60 ? 'good' : 'poor';
        scoreDiv.html(`
            <div class="review-score">
                <span>Document Quality Score:</span>
                <div class="score-bar">
                    <div class="score-fill ${scoreClass}" style="width: ${score}%"></div>
                </div>
                <span>${score}%</span>
            </div>
        `);
        
        // Display issues
        if (reviewResults.issues && reviewResults.issues.length > 0) {
            const issuesHtml = reviewResults.issues.map(issue => `
                <div class="review-issue ${issue.severity}">
                    <strong>${issue.type.replace(/_/g, ' ').toUpperCase()}:</strong> ${issue.message}
                </div>
            `).join('');
            issuesDiv.html('<h6>Issues Found:</h6>' + issuesHtml);
        }
        
        // Display suggestions
        if (reviewResults.suggestions && reviewResults.suggestions.length > 0) {
            const suggestionsHtml = reviewResults.suggestions.map(suggestion => `
                <li>${suggestion}</li>
            `).join('');
            suggestionsDiv.html(`
                <div class="review-suggestions">
                    <h6><i class="fas fa-lightbulb"></i> Suggestions:</h6>
                    <ul>${suggestionsHtml}</ul>
                </div>
            `);
        }
        
        reviewDiv.show();
    }

    // Display compliance validation results
    function displayComplianceResults(complianceValidation) {
        // This would show compliance issues in the modal
        // Implementation depends on your specific UI requirements
        console.log('Compliance validation:', complianceValidation);
    }

    // E-signature functionality
    $(document).on('click', '#esignBtn', function() {
        if (!currentDocumentId) {
            alert('Document must be saved before sending for e-signature');
            return;
        }
        
        // Show e-signature modal (you'd need to create this modal)
        showEsignatureModal();
    });

    function showEsignatureModal() {
        // First, get user's DocuSign configuration and usage status
        $.get('/api/esignature/config')
            .done(function(configResponse) {
                createEsignatureModal(configResponse);
            })
            .fail(function() {
                // If not authenticated, show login prompt or basic modal
                createEsignatureModal(null);
            });
    }

    function createEsignatureModal(configData) {
        const hasUserConfig = configData && configData.hasUserConfig;
        const platformUsage = configData ? configData.platformUsage : null;
        const canUsePlatform = platformUsage ? platformUsage.canUse : false;
        
        let configSection = '';
        
        if (hasUserConfig) {
            // User has their own DocuSign config
            configSection = `
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle"></i> <strong>Personal DocuSign Account</strong><br>
                    You're using your own DocuSign account with unlimited usage.
                </div>
            `;
        } else if (canUsePlatform && platformUsage) {
            // User can use platform account
            configSection = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> <strong>Free Tier - Platform Account</strong><br>
                    Documents remaining this month: <strong>${platformUsage.remaining.documents}</strong> of ${platformUsage.limits.free_tier_monthly_limit}<br>
                    <small class="text-muted">Using LegalFormsAI's DocuSign account</small>
                </div>
            `;
        } else if (platformUsage && !canUsePlatform) {
            // User has exceeded limits
            configSection = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Monthly Limit Reached</strong><br>
                    You've used all ${platformUsage.limits.free_tier_monthly_limit} free documents this month.<br>
                    <a href="#" class="btn btn-sm btn-outline-primary mt-2" onclick="window.showDocuSignSetup()">
                        <i class="fas fa-cog"></i> Configure Personal DocuSign Account
                    </a>
                </div>
            `;
        } else {
            // Default case
            configSection = `
                <div class="alert alert-secondary mb-3">
                    <i class="fas fa-user"></i> <strong>Authentication Required</strong><br>
                    Please log in to use e-signature features.
                </div>
            `;
        }

        // Create and show e-signature modal
        const modal = $(`
            <div class="modal fade" id="esignatureModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send for E-Signature</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${configSection}
                            
                            <form id="esignatureForm">
                                <div class="mb-3">
                                    <label class="form-label">Signers</label>
                                    <div id="signersContainer">
                                        <div class="signer-input mb-3">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" placeholder="Signer Name" name="signerName[]" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <input type="email" class="form-control" placeholder="Signer Email" name="signerEmail[]" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addSignerBtn">
                                        <i class="fas fa-plus"></i> Add Another Signer
                                    </button>
                                </div>
                                
                                ${!hasUserConfig && canUsePlatform ? `
                                <div class="mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Want unlimited e-signatures?</h6>
                                            <p class="card-text small">Configure your own DocuSign account to remove monthly limits.</p>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="setupPersonalAccountBtn">
                                                <i class="fas fa-cog"></i> Setup Personal Account
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="sendEsignBtn" 
                                ${(!hasUserConfig && !canUsePlatform) ? 'disabled' : ''}>
                                <i class="fas fa-signature"></i> Send for Signature
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        $('body').append(modal);
        $('#esignatureModal').modal('show');
        
        // Handle adding signers
        $('#addSignerBtn').on('click', function() {
            const signerInput = $(`
                <div class="signer-input mb-3">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control" placeholder="Signer Name" name="signerName[]" required>
                        </div>
                        <div class="col-md-5">
                            <input type="email" class="form-control" placeholder="Signer Email" name="signerEmail[]" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-signer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `);
            $('#signersContainer').append(signerInput);
        });
        
        // Handle removing signers
        $(document).on('click', '.remove-signer', function() {
            $(this).closest('.signer-input').remove();
        });
        
        // Handle sending for signature
        $('#sendEsignBtn').on('click', function() {
            const signers = [];
            $('#signersContainer .signer-input').each(function() {
                const name = $(this).find('input[name="signerName[]"]').val();
                const email = $(this).find('input[name="signerEmail[]"]').val();
                if (name && email) {
                    signers.push({ name, email });
                }
            });
            
            if (signers.length === 0) {
                alert('Please add at least one signer');
                return;
            }
            
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
            
            $.post('/api/esignature/send', {
                documentId: currentDocumentId,
                signers: signers
            })
            .done(function(response) {
                if (response.success) {
                    alert('Document sent for e-signature successfully!');
                    $('#esignatureModal').modal('hide');
                } else {
                    alert('Error: ' + response.error);
                }
            })
            .fail(function() {
                alert('Failed to send document for e-signature');
            })
            .always(function() {
                $('#sendEsignBtn').prop('disabled', false).html('Send for Signature');
            });
        });
        
        // Handle setup personal account button click
        $(document).on('click', '#setupPersonalAccountBtn', function() {
            showDocuSignSetup();
        });
        
        // Clean up modal when hidden
        $('#esignatureModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }

    // Show DocuSign setup modal
    function showDocuSignSetup() {
        console.log('showDocuSignSetup called');
        const setupModal = $(`
            <div class="modal fade" id="docusignSetupModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Configure Personal DocuSign Account</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                <strong>Why configure your own DocuSign account?</strong><br>
                                • Unlimited document sending<br>
                                • Your own branding<br>
                                • Direct control over your documents<br>
                                • No monthly limits
                            </div>
                            
                            <form id="docusignSetupForm">
                                <div class="mb-3">
                                    <label for="integrationKey" class="form-label">Integration Key *</label>
                                    <input type="text" class="form-control" id="integrationKey" name="integrationKey" required>
                                    <small class="form-text text-muted">Found in your DocuSign Developer Account</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="userGuid" class="form-label">User GUID *</label>
                                    <input type="text" class="form-control" id="userGuid" name="userGuid" required>
                                    <small class="form-text text-muted">Your DocuSign user identifier</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="accountId" class="form-label">Account ID *</label>
                                    <input type="text" class="form-control" id="accountId" name="accountId" required>
                                    <small class="form-text text-muted">Your DocuSign account identifier</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="basePath" class="form-label">Base Path</label>
                                    <select class="form-select" id="basePath" name="basePath">
                                        <option value="https://demo.docusign.net/restapi">Demo Environment</option>
                                        <option value="https://na1.docusign.net/restapi">Production (NA1)</option>
                                        <option value="https://na2.docusign.net/restapi">Production (NA2)</option>
                                        <option value="https://na3.docusign.net/restapi">Production (NA3)</option>
                                        <option value="https://eu.docusign.net/restapi">Production (EU)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="rsaPrivateKey" class="form-label">RSA Private Key *</label>
                                    <textarea class="form-control" id="rsaPrivateKey" name="rsaPrivateKey" rows="8" required
                                        placeholder="-----BEGIN RSA PRIVATE KEY-----
...your private key content...
-----END RSA PRIVATE KEY-----"></textarea>
                                    <small class="form-text text-muted">Your RSA private key (keep this secure!)</small>
                                </div>
                            </form>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Setup Instructions:</strong><br>
                                1. Create a DocuSign Developer Account<br>
                                2. Create an application with JWT authentication<br>
                                3. Generate RSA key pair and upload public key<br>
                                4. Grant user consent for your application<br>
                                <a href="https://developers.docusign.com/platform/auth/jwt/" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="fas fa-external-link-alt"></i> View Setup Guide
                                </a>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveDocuSignConfig">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        $('body').append(setupModal);
        $('#docusignSetupModal').modal('show');
        
        // Handle saving configuration
        $('#saveDocuSignConfig').on('click', function() {
            const formData = {
                integrationKey: $('#integrationKey').val(),
                userGuid: $('#userGuid').val(),
                accountId: $('#accountId').val(),
                basePath: $('#basePath').val(),
                rsaPrivateKey: $('#rsaPrivateKey').val()
            };
            
            // Validate required fields
            if (!formData.integrationKey || !formData.userGuid || !formData.accountId || !formData.rsaPrivateKey) {
                alert('Please fill in all required fields');
                return;
            }
            
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Testing & Saving...');
            
            $.post('/api/esignature/config', formData)
                .done(function(response) {
                    if (response.success) {
                        alert('DocuSign configuration saved successfully!');
                        $('#docusignSetupModal').modal('hide');
                        // Refresh the e-signature modal if it's open
                        if ($('#esignatureModal').length) {
                            $('#esignatureModal').modal('hide');
                            setTimeout(() => showEsignatureModal(), 500);
                        }
                    } else {
                        alert('Error: ' + response.error);
                    }
                })
                .fail(function(xhr) {
                    const response = xhr.responseJSON;
                    alert('Failed to save configuration: ' + (response ? response.error : 'Unknown error'));
                })
                .always(function() {
                    $('#saveDocuSignConfig').prop('disabled', false).html('<i class="fas fa-save"></i> Save Configuration');
                });
        });
        
        // Clean up modal when hidden
        $('#docusignSetupModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }

    // Override the original form submission to include new features
    $(document).off('submit', '#documentForm').on('submit', '#documentForm', function(e) {
        e.preventDefault();
        
        // Check if specific form type is selected
        const specificType = $('#specificFormType').val();
        if (!specificType) {
            alert('Please select a specific document type first.');
            return;
        }
        
        // Get selected format
        const format = $('#documentFormat').val() || 'pdf';
        
        // Collect form data
        const formData = {};
        $(this).find('input, select, textarea').each(function() {
            if (this.name) {
                formData[this.name] = this.value;
            }
        });
        
        // Add specific form type to form data
        formData.specific_form_type = specificType;
        
        // Show loading modal with format info
        $('#loadingModal .modal-body p').text(`Please wait while we create your ${format.toUpperCase()} legal document.`);
        $('#loadingModal').modal('show');
        
        // Get generation method
        const generationMethod = $('#generationMethod').val();
        const generationMode = generationMethod === 'template' ? 'professional_template' : 'ai_summary';
        
        // Submit to backend
        $.ajax({
            url: '/generate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                form_type: '<%= formType %>',
                specific_type: specificType,
                form_data: formData,
                format: format,
                generation_mode: generationMode
            }),
            success: handleGenerationSuccess,
            error: function(xhr) {
                $('#loadingModal').modal('hide');
                const response = xhr.responseJSON;
                if (response && response.complianceIssues) {
                    alert('Compliance issues found:\n' + response.complianceIssues.map(issue => issue.message).join('\n'));
                } else {
                    alert('Error generating document. Please try again.');
                }
            }
        });
    });

    // Setup compliance validation when form fields are loaded
    $(document).on('DOMSubtreeModified', '#formFields', function() {
        setupComplianceValidation();
    });

    // Example buttons - Pre-fill with sample lead data based on form type
    const formType = '<%= formType %>';

    // Define examples for each form type
    const examples = {
        'business': {
            example1: `I want to form a Limited Liability Company (LLC) for my consulting business. The company name is TechConsult Solutions LLC. The business will be registered in California. The registered agent is Sarah Johnson located at 456 Business Ave, Suite 200, Los Angeles, CA 90012. The business purpose is to provide technology consulting and software development services. There are two members: Michael Chen who owns 60% and holds the title of Managing Member, and Lisa Wong who owns 40% and is a Member. The company will be member-managed. The initial capital contribution is $50,000. The fiscal year will be calendar year. The business address is 789 Tech Park Drive, San Francisco, CA 94105.`,
            example2: `I need to create a Corporation for my manufacturing business. The corporation name is Advanced Manufacturing Inc. It will be registered in Delaware. The registered agent is Corporate Services LLC at 100 Corporate Blvd, Wilmington, DE 19801. The corporation purpose is to manufacture and distribute industrial equipment. The corporation will issue 10,000 shares of common stock with a par value of $1.00 per share. The incorporator is David Martinez. There are three directors: Jennifer Lee, Robert Brown, and Susan Taylor. The principal office is located at 500 Industrial Way, Chicago, IL 60601. The fiscal year ends on December 31.`
        },
        'real-estate': {
            example1: `I need to create a residential lease agreement for a property located at 123 Main Street, Apartment 4B, New York, NY 10001. The monthly rent is $2,500 and the security deposit is $2,500. The lease term is 12 months starting on January 1, 2026 and ending on December 31, 2026. The landlord is John Smith, phone number 555-123-4567, email john.smith@email.com. The tenant is Jane Doe, phone number 555-987-6543, email jane.doe@email.com. Utilities included are water and trash removal. Tenant is responsible for electricity and internet. Pets are allowed with a $300 pet deposit. No smoking is allowed on the property.`,
            example2: `I want to create a real estate purchase agreement. The property is a single-family home located at 456 Oak Avenue, Los Angeles, CA 90015. The purchase price is $750,000. The buyer is Mark Thompson and spouse Emily Thompson. The seller is Patricia Williams. The earnest money deposit is $25,000 to be held in escrow by ABC Title Company. The closing date is March 15, 2026. The sale includes all appliances, window treatments, and garage door openers. The property is being sold as-is. The buyer will obtain conventional financing. Contingencies include home inspection within 10 days and loan approval within 30 days.`
        },
        'family-law': {
            example1: `I need to file for divorce. My name is Amanda Roberts and my spouse is James Roberts. We were married on June 15, 2015 in Miami, Florida. We have been separated since January 1, 2025. We have two minor children: Emma Roberts age 8 and Noah Roberts age 5. We agree on joint legal custody with primary physical custody to me. We own a home at 789 Maple Drive, Miami, FL 33101 valued at $400,000 with a mortgage of $250,000. We have a joint savings account with $30,000 and a joint checking account with $5,000. My spouse has a 401k worth $80,000. We agree to divide assets equally. I am requesting child support based on state guidelines. No spousal support is being requested.`,
            example2: `I want to create a prenuptial agreement. My name is Christopher Davis and my future spouse is Rachel Martinez. We plan to marry on August 20, 2026 in Austin, Texas. I own a business called Davis Tech Solutions valued at $500,000. I also own a rental property at 234 River Road, Austin, TX 78701. My future spouse owns a home at 567 Hill Street, Austin, TX 78702 valued at $350,000. We agree that all property owned before marriage will remain separate property. Any property acquired during marriage will be community property. We each have separate retirement accounts that will remain separate. In case of divorce, no spousal support will be paid by either party. We each have consulted with independent legal counsel.`
        },
        'employment': {
            example1: `I need an employment agreement for a new hire. The company is Tech Innovations LLC located at 100 Tech Plaza, San Jose, CA 95101. The employee is Alex Morgan. The position is Senior Software Engineer. The start date is February 1, 2026. The annual salary is $120,000 paid bi-weekly. The employee is eligible for health insurance, dental insurance, and 401k with 4% company match. The employee will receive 15 days of PTO per year. The employment is at-will. The employee must sign a confidentiality agreement and non-compete for 12 months within a 50 mile radius. The employee will work Monday through Friday, 9am to 5pm, with option for remote work 2 days per week. The probationary period is 90 days.`,
            example2: `I want to create an independent contractor agreement. The company is Marketing Plus Inc located at 200 Commerce Street, Dallas, TX 75201. The contractor is Jordan Lee doing business as JL Creative Services. The services to be provided are graphic design and marketing materials creation. The contract term is 6 months from January 1, 2026 to June 30, 2026 with option to renew. The compensation is $5,000 per month paid on the first of each month. The contractor will provide their own equipment and software. The contractor can work for other clients. All work product will be owned by the company. The contractor must maintain liability insurance of at least $1 million. Either party can terminate with 30 days written notice.`
        },
        'contracts': {
            example1: `I need a service agreement between my company and a client. My company is ABC Services LLC located at 300 Business Park, Seattle, WA 98101. The client is XYZ Corporation at 400 Corporate Center, Portland, OR 97201. We will provide IT support and maintenance services. The contract term is one year starting March 1, 2026. The monthly fee is $3,000 for up to 40 hours of service per month. Additional hours are billed at $100 per hour. Payment is due within 15 days of invoice. We will provide 24/7 emergency support. Response time for critical issues is 2 hours. The contract automatically renews unless either party gives 60 days notice. We provide a 99% uptime guarantee. Liability is limited to the amount paid in the previous 3 months.`,
            example2: `I want to create a non-disclosure agreement. The disclosing party is Innovation Tech Inc located at 500 Startup Way, Boston, MA 02101. The receiving party is Venture Partners LLC at 600 Investment Plaza, New York, NY 10001. The purpose is to discuss a potential business partnership and investment opportunity. The confidential information includes business plans, financial projections, customer lists, and proprietary technology. The receiving party agrees not to disclose the information to third parties and to use it only for evaluation purposes. The NDA term is 3 years from the date of signing. The receiving party must return or destroy all confidential materials upon request. The agreement is governed by Massachusetts law.`
        },
        'litigation': {
            example1: `I need to file a civil complaint. I am the plaintiff, Thomas Anderson, residing at 700 Elm Street, Phoenix, AZ 85001. The defendant is Global Services Corp located at 800 Corporate Drive, Phoenix, AZ 85002. On September 15, 2025, I entered into a contract with the defendant to provide consulting services for $50,000. I completed all services by November 1, 2025 as agreed. Despite multiple demands, the defendant has refused to pay the agreed amount. I am owed $50,000 plus interest. I have suffered damages including lost business opportunities valued at $10,000. I am requesting judgment for $60,000 plus interest, costs, and attorney fees. I have attached the signed contract and proof of completed work.`,
            example2: `I want to file a small claims complaint. I am the plaintiff, Maria Garcia, at 900 Main Avenue, Miami, FL 33101. The defendant is Quick Fix Repairs, a sole proprietorship owned by Tom Wilson at 1000 Service Road, Miami, FL 33102. On July 20, 2025, I paid the defendant $3,500 to repair my roof. The defendant did incomplete and substandard work. The roof still leaks and other contractors estimate it will cost $4,000 to properly repair. I contacted the defendant multiple times but they refused to fix the problems or provide a refund. I am requesting $3,500 refund plus $500 for additional damages to interior ceiling. Total claim amount is $4,000.`
        }
    };

    $(document).on('click', '#example1Btn', function() {
        let exampleText = examples[formType]?.example1 || examples['business'].example1;
        $('#naturalLanguageInput').val(exampleText);
        $('#naturalLanguageInput').focus();
    });

    $(document).on('click', '#example2Btn', function() {
        let exampleText = examples[formType]?.example2 || examples['business'].example2;
        $('#naturalLanguageInput').val(exampleText);
        $('#naturalLanguageInput').focus();
    });
    </script>

    <!-- Include enhanced feature scripts -->
    <script src="/js/compliance.js"></script>
    <script src="/js/nlp.js"></script>
    <script src="/js/voice-input.js"></script>
</body>
</html>
