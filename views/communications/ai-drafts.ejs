<%- include('../base-pm', {
    title: 'AI Communication Assistant',
    description: 'AI-powered email and message drafting'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-robot me-2"></i>AI Communication Assistant</h2>
            <p class="text-muted mb-0">AI-powered drafting for client communications</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.total_drafts || 0 %></h3>
                    <small>Total Drafts</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.pending_count || 0 %></h3>
                    <small>Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.sent_count || 0 %></h3>
                    <small>Sent</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- New Draft Form -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Draft New Message</h5>
                </div>
                <div class="card-body">
                    <form id="draftForm">
                        <div class="mb-3">
                            <label class="form-label">Client (optional)</label>
                            <select class="form-select" name="client_id">
                                <option value="">No specific client</option>
                                <% clients.forEach(c => { %>
                                <option value="<%= c.id %>"><%= c.name %> (<%= c.email %>)</option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Subject/Topic</label>
                            <input type="text" class="form-control" name="subject" placeholder="e.g., Case status update">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Message Type</label>
                                <select class="form-select" name="draft_type">
                                    <option value="email">Email</option>
                                    <option value="letter">Formal Letter</option>
                                    <option value="memo">Internal Memo</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tone</label>
                                <select class="form-select" name="tone">
                                    <option value="professional">Professional</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="empathetic">Empathetic</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="formal">Highly Formal</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Context / Instructions <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="context" rows="5" required
                                placeholder="Describe what you want to communicate. Include key points, any specific information to mention, and the purpose of the message..."></textarea>
                        </div>

                        <button type="button" class="btn btn-outline-info me-2" id="loadExampleBtn">
                            <i class="fas fa-flask me-1"></i>Load Example
                        </button>
                        <button type="submit" class="btn btn-primary" id="draftBtn">
                            <i class="fas fa-magic me-1"></i>Generate Draft
                        </button>
                    </form>
                </div>
            </div>

            <!-- Message Classifier -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Message Classifier</h5>
                </div>
                <div class="card-body">
                    <form id="classifyForm">
                        <div class="mb-3">
                            <label class="form-label">Paste Message to Classify</label>
                            <textarea class="form-control" name="message_content" rows="4"
                                placeholder="Paste an incoming message to analyze its urgency, sentiment, and suggested action..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-outline-primary" id="classifyBtn">
                            <i class="fas fa-search me-1"></i>Analyze Message
                        </button>
                    </form>
                    <div id="classificationResult" class="mt-3 d-none"></div>
                </div>
            </div>
        </div>

        <!-- Generated Draft / Recent Drafts -->
        <div class="col-lg-6">
            <div id="generatedDraft" class="card mb-4 d-none">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check me-2"></i>Generated Draft</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" id="draftSubject">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" id="draftBody" rows="10"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="copyDraftBtn">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                        <button class="btn btn-success" id="markSentBtn">
                            <i class="fas fa-paper-plane me-1"></i>Mark as Sent
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Drafts</h5>
                </div>
                <div class="card-body">
                    <% if (drafts.length > 0) { %>
                    <div class="list-group">
                        <% drafts.slice(0, 10).forEach(d => { %>
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1"><%= d.subject_line || 'No subject' %></h6>
                                    <p class="mb-1 text-muted small">
                                        <%= (d.ai_draft || '').substring(0, 100) %>...
                                    </p>
                                    <small class="text-muted">
                                        <%= new Date(d.created_at).toLocaleDateString() %>
                                        <% if (d.client_name) { %> | <%= d.client_name %><% } %>
                                        <span class="badge bg-<%= d.status === 'sent' ? 'success' : 'warning' %> ms-1">
                                            <%= d.status %>
                                        </span>
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary view-draft-btn"
                                        data-subject="<%= d.subject_line %>"
                                        data-body="<%= d.ai_draft %>">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="text-muted text-center">No drafts yet</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load Example Data
document.getElementById('loadExampleBtn').addEventListener('click', function() {
    document.querySelector('[name=subject]').value = 'Case Status Update - Williams v. ABC Corporation';
    document.querySelector('[name=draft_type]').value = 'email';
    document.querySelector('[name=tone]').value = 'professional';
    document.querySelector('[name=context]').value = `Please draft an email to the client updating them on the status of their case. Key points to include:

1. We received the defendant's response to our discovery requests yesterday
2. The defendant has produced approximately 2,500 documents which our team is now reviewing
3. We identified several potentially important emails between the defendant's executives
4. The deposition of the defendant's CEO is scheduled for March 15, 2024
5. We expect to complete document review within the next two weeks
6. Next steps include preparing deposition outlines and potentially filing a motion to compel additional discovery

The client has been anxious about the progress of their case and needs reassurance that things are moving forward. Please be encouraging but realistic about the timeline.`;
});

let currentDraftId = null;

document.getElementById('draftForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('draftBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await fetch('/api/ai-communications/draft-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success) {
            currentDraftId = result.draft.id;
            document.getElementById('draftSubject').value = result.result.subject_line;
            document.getElementById('draftBody').value = result.result.body;
            document.getElementById('generatedDraft').classList.remove('d-none');

            // Scroll to draft
            document.getElementById('generatedDraft').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic me-1"></i>Generate Draft';
    }
});

document.getElementById('classifyForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('classifyBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';

    const content = document.querySelector('[name=message_content]').value;

    try {
        const res = await fetch('/api/ai-communications/classify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message_content: content })
        });
        const result = await res.json();

        if (result.success) {
            const c = result.classification;
            document.getElementById('classificationResult').innerHTML = `
                <div class="alert alert-info">
                    <h6>Classification Results</h6>
                    <p class="mb-1"><strong>Category:</strong> ${c.category}</p>
                    <p class="mb-1"><strong>Urgency:</strong> <span class="badge bg-${c.urgency_level === 'critical' ? 'danger' : c.urgency_level === 'high' ? 'warning' : 'secondary'}">${c.urgency_level}</span></p>
                    <p class="mb-1"><strong>Sentiment:</strong> ${c.sentiment}</p>
                    <p class="mb-0"><strong>Suggested Action:</strong> ${c.suggested_action}</p>
                </div>
            `;
            document.getElementById('classificationResult').classList.remove('d-none');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search me-1"></i>Analyze Message';
    }
});

document.getElementById('copyDraftBtn').addEventListener('click', function() {
    const body = document.getElementById('draftBody').value;
    navigator.clipboard.writeText(body).then(() => {
        this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-copy me-1"></i>Copy';
        }, 2000);
    });
});

document.getElementById('markSentBtn').addEventListener('click', async function() {
    if (!currentDraftId) return;

    try {
        await fetch(`/api/ai-communications/draft/${currentDraftId}/send`, { method: 'POST' });
        alert('Marked as sent!');
        location.reload();
    } catch (e) {
        alert('Error: ' + e.message);
    }
});

// View past draft
document.querySelectorAll('.view-draft-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('draftSubject').value = this.dataset.subject || '';
        document.getElementById('draftBody').value = this.dataset.body || '';
        document.getElementById('generatedDraft').classList.remove('d-none');
    });
});
</script>
</body>
</html>
