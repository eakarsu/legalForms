<%- include('../base-pm', {
    title: 'Citation Search',
    description: 'Find relevant legal citations'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-search me-2"></i>New Citation Search</h2>
            <p class="text-muted mb-0">Find relevant case law, statutes, and legal authorities</p>
        </div>
        <a href="/citation-finder" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Search Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-3">
                            <label class="form-label">Legal Issue <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="legal_issue" rows="4" required
                                placeholder="Describe the legal issue you're researching. Be specific about the facts, legal questions, and any relevant context..."></textarea>
                            <small class="text-muted">Example: "Landlord's duty to maintain safe premises when tenant is injured by criminal act of third party"</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Jurisdiction</label>
                                <select class="form-select" name="jurisdiction">
                                    <option value="">All Jurisdictions</option>
                                    <% jurisdictions.forEach(j => { %>
                                    <option value="<%= j %>"><%= j %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Practice Area</label>
                                <select class="form-select" name="practice_area">
                                    <option value="">All Practice Areas</option>
                                    <% practiceAreas.forEach(pa => { %>
                                    <option value="<%= pa %>"><%= pa %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Search Type</label>
                                <select class="form-select" name="search_type">
                                    <option value="general">General Research</option>
                                    <option value="case_law">Case Law Only</option>
                                    <option value="statutes">Statutes & Regulations</option>
                                    <option value="supporting">Supporting Authorities</option>
                                    <option value="opposing">Opposing Authorities</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Link to Case (optional)</label>
                                <select class="form-select" name="case_id">
                                    <option value="">No case</option>
                                    <% cases.forEach(c => { %>
                                    <option value="<%= c.id %>"><%= c.case_number %> - <%= c.title %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> AI-generated citations should be verified for accuracy before use in legal documents. Always confirm citations through official legal databases.
                        </div>

                        <button type="button" class="btn btn-outline-info me-2" id="loadExampleBtn">
                            <i class="fas fa-flask me-1"></i>Load Example
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" id="searchBtn">
                            <i class="fas fa-search me-1"></i>Search for Citations
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Search Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <strong><i class="fas fa-check text-success me-2"></i>Be Specific</strong>
                            <p class="text-muted small mb-0">Include relevant facts, parties, and the specific legal question.</p>
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-check text-success me-2"></i>Include Context</strong>
                            <p class="text-muted small mb-0">Mention the type of case (civil, criminal, administrative).</p>
                        </li>
                        <li class="mb-3">
                            <strong><i class="fas fa-check text-success me-2"></i>Specify Jurisdiction</strong>
                            <p class="text-muted small mb-0">Narrow results to your relevant jurisdiction for better matches.</p>
                        </li>
                        <li>
                            <strong><i class="fas fa-check text-success me-2"></i>Verify Results</strong>
                            <p class="text-muted small mb-0">Always verify AI-suggested citations through official sources.</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load Example Data
document.getElementById('loadExampleBtn').addEventListener('click', function() {
    document.querySelector('[name=legal_issue]').value = 'Landlord liability for injuries caused by criminal acts of third parties on the premises. Specifically, whether a commercial property owner has a duty to provide security measures when there is a history of criminal activity in the area, and what standard of care applies.';
    document.querySelector('[name=jurisdiction]').value = 'California';
    document.querySelector('[name=practice_area]').value = 'Personal Injury';
    document.querySelector('[name=search_type]').value = 'case_law';
});

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('searchBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching...';

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await fetch('/api/citation-finder/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success) {
            window.location.href = `/citation-finder/results/${result.searchId}`;
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search me-1"></i>Search for Citations';
    }
});
</script>
</body>
</html>
