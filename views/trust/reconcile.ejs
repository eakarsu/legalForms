<%- include('../base-pm', {
    title: title,
    description: 'Trust account reconciliation'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/trust">Trust Accounting</a></li>
                    <li class="breadcrumb-item"><a href="/trust/<%= account.id %>"><%= account.account_name %></a></li>
                    <li class="breadcrumb-item active">Reconcile</li>
                </ol>
            </nav>
            <h2><i class="fas fa-balance-scale me-2"></i>Reconcile Account</h2>
            <p class="text-muted mb-0"><%= account.account_name %> - <%= account.bank_name %></p>
        </div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newReconciliationModal">
            <i class="fas fa-plus me-1"></i>Start Reconciliation
        </button>
    </div>

    <!-- Current Balance vs Book Balance -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>$<%= parseFloat(account.current_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) %></h3>
                    <small>Book Balance</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3><%= unreconciled.length %></h3>
                    <small>Unreconciled Items</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3><%= reconciliations.length %></h3>
                    <small>Past Reconciliations</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Unreconciled Transactions -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Unreconciled Transactions</h5>
                </div>
                <div class="card-body">
                    <% if (unreconciled.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% unreconciled.forEach(tx => { %>
                                <tr>
                                    <td><input type="checkbox" class="tx-checkbox" data-id="<%= tx.id %>"></td>
                                    <td><%= new Date(tx.transaction_date).toLocaleDateString() %></td>
                                    <td><%= tx.first_name %> <%= tx.last_name %></td>
                                    <td><%= tx.description %></td>
                                    <td class="text-end <%= tx.transaction_type === 'deposit' ? 'text-success' : 'text-danger' %>">
                                        <%= tx.transaction_type === 'deposit' ? '+' : '-' %>$<%= parseFloat(tx.amount).toFixed(2) %>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="reconcileSelected()">
                            <i class="fas fa-check me-1"></i>Mark Selected as Reconciled
                        </button>
                    </div>
                    <% } else { %>
                    <p class="text-muted text-center mb-0">All transactions are reconciled</p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Reconciliation History -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Reconciliation History</h5>
                </div>
                <div class="card-body">
                    <% if (reconciliations.length > 0) { %>
                    <div class="list-group">
                        <% reconciliations.forEach(rec => { %>
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><%= new Date(rec.statement_date).toLocaleDateString() %></strong>
                                    <br><small class="text-muted">
                                        Statement: $<%= parseFloat(rec.statement_balance).toFixed(2) %>
                                    </small>
                                </div>
                                <span class="badge bg-<%= rec.is_balanced ? 'success' : 'warning' %>">
                                    <%= rec.is_balanced ? 'Balanced' : 'Pending' %>
                                </span>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="text-muted text-center mb-0">No reconciliation history</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Reconciliation Modal -->
<div class="modal fade" id="newReconciliationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Reconciliation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reconciliationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Statement Date</label>
                        <input type="date" name="statement_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Statement Ending Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" name="statement_balance" class="form-control" step="0.01" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Reconciliation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.tx-checkbox').forEach(cb => cb.checked = this.checked);
});

async function reconcileSelected() {
    const selected = Array.from(document.querySelectorAll('.tx-checkbox:checked')).map(cb => cb.dataset.id);
    if (selected.length === 0) {
        alert('Please select transactions to reconcile');
        return;
    }

    try {
        const response = await fetch('/api/trust/<%= account.id %>/reconcile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transaction_ids: selected })
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Reconciliation failed');
    }
}

document.getElementById('reconciliationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());

    try {
        const response = await fetch('/api/trust/<%= account.id %>/reconciliations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to start reconciliation');
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
