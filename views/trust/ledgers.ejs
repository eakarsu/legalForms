<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'trust' }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-book me-2"></i>Client Ledgers</h2>
            <p class="text-muted mb-0">View trust fund balances by client</p>
        </div>
        <a href="/trust" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Account</th>
                        <th>Balance</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (ledgers.length === 0) { %>
                    <tr><td colspan="5" class="text-center text-muted py-4">No client ledgers found</td></tr>
                    <% } else { %>
                    <% ledgers.forEach(ledger => { %>
                    <tr class="clickable-row" data-href="/trust/<%= ledger.trust_account_id %>/ledger/<%= ledger.id %>" style="cursor: pointer;">
                        <td><strong><%= ledger.company_name || (ledger.first_name + ' ' + ledger.last_name) || 'Unknown Client' %></strong></td>
                        <td><%= ledger.account_name || 'N/A' %></td>
                        <td class="<%= parseFloat(ledger.current_balance || 0) >= 0 ? 'text-success' : 'text-danger' %>">$<%= parseFloat(ledger.current_balance || 0).toFixed(2) %></td>
                        <td><%= ledger.updated_at ? new Date(ledger.updated_at).toLocaleDateString() : (ledger.created_at ? new Date(ledger.created_at).toLocaleDateString() : 'N/A') %></td>
                        <td onclick="event.stopPropagation();">
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteLedger('<%= ledger.id %>', '<%= ledger.trust_account_id %>')" title="Delete Ledger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Row click handlers - navigate to ledger details
document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function() {
        if (this.dataset.href) {
            window.location.href = this.dataset.href;
        }
    });
});

async function deleteLedger(ledgerId, accountId) {
    if (!confirm('Are you sure you want to delete this ledger? This will also delete all associated transactions.')) {
        return;
    }

    const url = `/api/trust/${accountId}/ledgers/${ledgerId}`;
    console.log('Delete URL:', url);

    try {
        const response = await fetch(url, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to delete ledger'));
        }
    } catch (error) {
        alert('Failed to delete ledger');
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
