<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'cases' }) %>

    <div class="pm-container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/cases">Cases</a></li>
                <li class="breadcrumb-item active"><%= caseData.case_number %></li>
            </ol>
        </nav>

        <div class="pm-header">
            <div class="pm-header-content">
                <h1><%= caseData.title %></h1>
                <div class="mt-2">
                    <span class="badge bg-<%= caseData.status === 'open' ? 'success' : caseData.status === 'pending' ? 'warning' : 'secondary' %> me-2"><%= caseData.status %></span>
                    <span class="badge bg-<%= caseData.priority === 'urgent' ? 'danger' : caseData.priority === 'high' ? 'warning' : 'info' %>"><%= caseData.priority %> priority</span>
                </div>
            </div>
            <div>
                <a href="/cases/<%= caseData.id %>/edit" class="btn btn-outline-primary me-2">
                    <i class="fas fa-edit me-1"></i>Edit
                </a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTimeModal">
                    <i class="fas fa-stopwatch me-1"></i>Log Time
                </button>
            </div>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-4 mb-4">
                <!-- Case Info -->
                <div class="card mb-4">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Case Details</h5></div>
                    <div class="card-body">
                        <p><strong>Case Number:</strong> <%= caseData.case_number %></p>
                        <p><strong>Type:</strong> <%= caseData.case_type %></p>
                        <p><strong>Opened:</strong> <%= new Date(caseData.date_opened).toLocaleDateString() %></p>
                        <% if (caseData.statute_of_limitations) { %>
                            <p><strong>SOL:</strong> <span class="text-danger"><%= new Date(caseData.statute_of_limitations).toLocaleDateString() %></span></p>
                        <% } %>
                        <% if (caseData.court_name) { %>
                            <hr>
                            <p><strong>Court:</strong> <%= caseData.court_name %></p>
                            <% if (caseData.court_case_number) { %><p><strong>Court Case #:</strong> <%= caseData.court_case_number %></p><% } %>
                            <% if (caseData.judge_name) { %><p><strong>Judge:</strong> <%= caseData.judge_name %></p><% } %>
                        <% } %>
                        <% if (caseData.opposing_party) { %>
                            <hr>
                            <p><strong>Opposing Party:</strong> <%= caseData.opposing_party %></p>
                            <% if (caseData.opposing_counsel) { %><p><strong>Opposing Counsel:</strong> <%= caseData.opposing_counsel %></p><% } %>
                        <% } %>
                    </div>
                </div>

                <!-- Client Info -->
                <% if (caseData.client_id) { %>
                    <div class="card mb-4">
                        <div class="card-header"><h5 class="mb-0"><i class="fas fa-user me-2"></i>Client</h5></div>
                        <div class="card-body">
                            <h6><a href="/clients/<%= caseData.client_id %>"><%= caseData.client_type === 'business' ? caseData.client_company : caseData.client_first_name + ' ' + caseData.client_last_name %></a></h6>
                            <% if (caseData.client_email) { %><p class="mb-1"><i class="fas fa-envelope me-2 text-muted"></i><%= caseData.client_email %></p><% } %>
                            <% if (caseData.client_phone) { %><p class="mb-0"><i class="fas fa-phone me-2 text-muted"></i><%= caseData.client_phone %></p><% } %>
                        </div>
                    </div>
                <% } %>

                <!-- Billing Summary -->
                <div class="card mb-4">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Billing</h5></div>
                    <div class="card-body">
                        <p><strong>Type:</strong> <%= caseData.billing_type %></p>
                        <% if (caseData.billing_rate) { %><p><strong>Rate:</strong> $<%= caseData.billing_rate %>/hr</p><% } %>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Hours:</span>
                            <strong><%= (billing.total_minutes / 60).toFixed(1) %>h</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Amount:</span>
                            <strong>$<%= parseFloat(billing.total_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Unbilled:</span>
                            <strong class="text-warning">$<%= parseFloat(billing.unbilled_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></strong>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Events -->
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Upcoming Events</h5></div>
                    <div class="card-body">
                        <% if (events.length === 0) { %>
                            <p class="text-muted small">No upcoming events</p>
                        <% } else { %>
                            <% events.forEach(event => { %>
                                <div class="mb-2 pb-2 border-bottom">
                                    <strong><%= event.title %></strong><br>
                                    <small class="text-muted"><%= new Date(event.start_time).toLocaleDateString() %></small>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-8">
                <!-- Deadlines -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Deadlines</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addDeadlineModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <% if (deadlines.length === 0) { %>
                            <div class="text-center py-4"><p class="text-muted">No deadlines</p></div>
                        <% } else { %>
                            <ul class="list-group list-group-flush">
                                <% deadlines.forEach(d => {
                                    const daysUntil = Math.ceil((new Date(d.due_date) - new Date()) / (1000 * 60 * 60 * 24));
                                %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong><%= d.title %></strong>
                                            <br><small class="text-muted"><%= d.deadline_type %></small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-<%= daysUntil < 0 ? 'danger' : daysUntil <= 7 ? 'warning' : 'info' %>">
                                                <%= daysUntil < 0 ? 'Overdue' : daysUntil + ' days' %>
                                            </span>
                                            <br><small><%= new Date(d.due_date).toLocaleDateString() %></small>
                                        </div>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } %>
                    </div>
                </div>

                <!-- Time Entries -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Recent Time Entries</h5>
                        <a href="/billing/time?case_id=<%= caseData.id %>" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <% if (timeEntries.length === 0) { %>
                            <div class="text-center py-4"><p class="text-muted">No time entries</p></div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead><tr><th>Date</th><th>Description</th><th>Duration</th><th>Amount</th></tr></thead>
                                    <tbody>
                                        <% timeEntries.forEach(te => { %>
                                            <tr>
                                                <td><%= new Date(te.date).toLocaleDateString() %></td>
                                                <td><%= te.description.substring(0, 50) %><%= te.description.length > 50 ? '...' : '' %></td>
                                                <td><%= (te.duration_minutes / 60).toFixed(1) %>h</td>
                                                <td>$<%= parseFloat(te.amount || 0).toFixed(2) %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <% if (notes.length === 0) { %>
                            <p class="text-muted">No notes yet</p>
                        <% } else { %>
                            <% notes.forEach(note => { %>
                                <div class="mb-3 pb-3 border-bottom">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="badge bg-<%= note.note_type === 'court' ? 'danger' : note.note_type === 'client' ? 'primary' : 'secondary' %>"><%= note.note_type %></span>
                                        <small class="text-muted"><%= new Date(note.created_at).toLocaleString() %></small>
                                    </div>
                                    <p class="mb-0"><%= note.content %></p>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                </div>

                <!-- Documents -->
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Documents</h5></div>
                    <div class="card-body p-0">
                        <% if (documents.length === 0) { %>
                            <div class="text-center py-4"><p class="text-muted">No documents linked</p></div>
                        <% } else { %>
                            <ul class="list-group list-group-flush">
                                <% documents.forEach(doc => { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-file-alt me-2"></i><%= doc.document_type %>
                                            <br><small class="text-muted">Added <%= new Date(doc.added_at).toLocaleDateString() %></small>
                                        </div>
                                        <a href="/download/<%= doc.id %>" class="btn btn-sm btn-outline-primary">Download</a>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal fade" id="addNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add Note</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Note Type</label>
                        <select id="noteType" class="form-select">
                            <option value="general">General</option>
                            <option value="court">Court</option>
                            <option value="client">Client</option>
                            <option value="internal">Internal</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea id="noteContent" class="form-control" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Time Modal -->
    <div class="modal fade" id="addTimeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Log Time</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="timeDescription" class="form-control" rows="2" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Hours</label>
                            <input type="number" id="timeHours" class="form-control" min="0" value="0">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Minutes</label>
                            <input type="number" id="timeMinutes" class="form-control" min="0" max="59" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate ($/hr)</label>
                        <input type="number" id="timeRate" class="form-control" value="<%= caseData.billing_rate || 250 %>">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Activity Type</label>
                        <select id="timeActivity" class="form-select">
                            <option value="research">Research</option>
                            <option value="drafting">Drafting</option>
                            <option value="review">Review</option>
                            <option value="meeting">Meeting</option>
                            <option value="call">Phone Call</option>
                            <option value="court">Court</option>
                            <option value="travel">Travel</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTime()">Save Time</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Deadline Modal -->
    <div class="modal fade" id="addDeadlineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add Deadline</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" id="deadlineTitle" class="form-control" placeholder="e.g., Motion Filing Deadline" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date <span class="text-danger">*</span></label>
                        <input type="date" id="deadlineDueDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Deadline Type</label>
                        <select id="deadlineType" class="form-select">
                            <option value="filing">Filing Deadline</option>
                            <option value="discovery">Discovery</option>
                            <option value="response">Response Due</option>
                            <option value="hearing">Hearing</option>
                            <option value="statute">Statute of Limitations</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="deadlineDescription" class="form-control" rows="2" placeholder="Optional details"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Warning Days</label>
                            <input type="number" id="deadlineWarningDays" class="form-control" value="7" min="0">
                            <small class="text-muted">Days before to show warning</small>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Priority</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="deadlineCritical">
                                <label class="form-check-label" for="deadlineCritical">Critical Deadline</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDeadline()">Save Deadline</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function saveNote() {
            fetch('/api/cases/<%= caseData.id %>/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: document.getElementById('noteContent').value,
                    note_type: document.getElementById('noteType').value
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('Error saving note: ' + (data.error || 'Unknown error'));
            })
            .catch(err => {
                alert('Failed to save note');
                console.error(err);
            });
        }

        function saveTime() {
            const hours = parseInt(document.getElementById('timeHours').value) || 0;
            const minutes = parseInt(document.getElementById('timeMinutes').value) || 0;
            fetch('/api/time-entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    case_id: '<%= caseData.id %>',
                    description: document.getElementById('timeDescription').value,
                    duration_minutes: hours * 60 + minutes,
                    hourly_rate: document.getElementById('timeRate').value,
                    activity_type: document.getElementById('timeActivity').value
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('Error saving time entry: ' + (data.error || 'Unknown error'));
            })
            .catch(err => {
                alert('Failed to save time entry');
                console.error(err);
            });
        }

        function saveDeadline() {
            const title = document.getElementById('deadlineTitle').value;
            const dueDate = document.getElementById('deadlineDueDate').value;

            if (!title || !dueDate) {
                alert('Please fill in Title and Due Date');
                return;
            }

            fetch('/api/deadlines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    case_id: '<%= caseData.id %>',
                    title: title,
                    due_date: dueDate,
                    deadline_type: document.getElementById('deadlineType').value,
                    description: document.getElementById('deadlineDescription').value,
                    warning_days: parseInt(document.getElementById('deadlineWarningDays').value) || 7,
                    is_critical: document.getElementById('deadlineCritical').checked
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('Error saving deadline: ' + (data.error || 'Unknown error'));
            })
            .catch(err => {
                alert('Failed to save deadline');
                console.error(err);
            });
        }
    </script>
<%- include('../partials/footer') %>
</body>
</html>
