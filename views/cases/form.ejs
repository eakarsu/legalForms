<%- include('../base-pm', { title: title }) %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<style>
    .sol-date-input { font-weight: 500; }
    .sol-warning { padding: 8px 12px; border-radius: 4px; font-size: 0.85rem; }
    .sol-warning.danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .sol-warning.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .sol-warning.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .sol-warning.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .flatpickr-calendar { box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 8px; }
</style>
<%- include('../partials/pm-nav', { active: 'cases' }) %>

    <div class="pm-container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/cases">Cases</a></li>
                <li class="breadcrumb-item active"><%= title %></li>
            </ol>
        </nav>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-briefcase me-2"></i><%= title %></h4>
                    </div>
                    <div class="card-body">
                        <% if (errors && errors.length > 0) { %>
                            <div class="alert alert-danger">
                                <ul class="mb-0"><% errors.forEach(error => { %><li><%= error.msg %></li><% }) %></ul>
                            </div>
                        <% } %>

                        <form method="POST" action="<%= (typeof caseData !== 'undefined' && caseData) ? '/cases/' + caseData.id : '/cases' %>">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Case Title *</label>
                                    <input type="text" name="title" class="form-control" required value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.title : '' %>">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Client</label>
                                    <select name="client_id" class="form-select">
                                        <option value="">No Client</option>
                                        <% clients.forEach(c => { %>
                                            <option value="<%= c.id %>" <%= ((typeof caseData !== 'undefined' && caseData && caseData.client_id === c.id) || (typeof req !== 'undefined' && req.query && req.query.client_id === c.id)) ? 'selected' : '' %>>
                                                <%= c.client_type === 'business' ? c.company_name : c.first_name + ' ' + c.last_name %>
                                            </option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="3"><%= (typeof caseData !== 'undefined' && caseData) ? caseData.description : '' %></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Case Type</label>
                                    <select name="case_type" class="form-select">
                                        <option value="litigation" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'litigation') ? 'selected' : '' %>>Litigation</option>
                                        <option value="corporate" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'corporate') ? 'selected' : '' %>>Corporate</option>
                                        <option value="family" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'family') ? 'selected' : '' %>>Family Law</option>
                                        <option value="estate" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'estate') ? 'selected' : '' %>>Estate Planning</option>
                                        <option value="real_estate" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'real_estate') ? 'selected' : '' %>>Real Estate</option>
                                        <option value="employment" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'employment') ? 'selected' : '' %>>Employment</option>
                                        <option value="criminal" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'criminal') ? 'selected' : '' %>>Criminal</option>
                                        <option value="general" <%= (typeof caseData !== 'undefined' && caseData && caseData.case_type === 'general') ? 'selected' : '' %>>General</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Status</label>
                                    <select name="status" class="form-select">
                                        <option value="open" <%= (!caseData || (typeof caseData !== 'undefined' && caseData && caseData.status === 'open')) ? 'selected' : '' %>>Open</option>
                                        <option value="pending" <%= (typeof caseData !== 'undefined' && caseData && caseData.status === 'pending') ? 'selected' : '' %>>Pending</option>
                                        <option value="closed" <%= (typeof caseData !== 'undefined' && caseData && caseData.status === 'closed') ? 'selected' : '' %>>Closed</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Priority</label>
                                    <select name="priority" class="form-select">
                                        <option value="low" <%= (typeof caseData !== 'undefined' && caseData && caseData.priority === 'low') ? 'selected' : '' %>>Low</option>
                                        <option value="medium" <%= (!caseData || (typeof caseData !== 'undefined' && caseData && caseData.priority === 'medium')) ? 'selected' : '' %>>Medium</option>
                                        <option value="high" <%= (typeof caseData !== 'undefined' && caseData && caseData.priority === 'high') ? 'selected' : '' %>>High</option>
                                        <option value="urgent" <%= (typeof caseData !== 'undefined' && caseData && caseData.priority === 'urgent') ? 'selected' : '' %>>Urgent</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Date Opened</label>
                                    <input type="date" name="date_opened" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData && caseData.date_opened) ? new Date(caseData.date_opened).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>">
                                </div>
                            </div>

                            <hr><h5>Court Information (Optional)</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Court Name</label>
                                    <input type="text" name="court_name" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.court_name : '' %>">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Court Case #</label>
                                    <input type="text" name="court_case_number" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.court_case_number : '' %>">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Judge</label>
                                    <input type="text" name="judge_name" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.judge_name : '' %>">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Opposing Party</label>
                                    <input type="text" name="opposing_party" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.opposing_party : '' %>">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Opposing Counsel</label>
                                    <input type="text" name="opposing_counsel" class="form-control" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.opposing_counsel : '' %>">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-exclamation-triangle text-warning me-1"></i>Statute of Limitations</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-warning text-dark"><i class="fas fa-calendar-exclamation"></i></span>
                                    <input type="text" name="statute_of_limitations" id="solDatePicker" class="form-control sol-date-input" placeholder="Select SOL date..." value="<%= (typeof caseData !== 'undefined' && caseData && caseData.statute_of_limitations) ? new Date(caseData.statute_of_limitations).toISOString().split('T')[0] : '' %>">
                                    <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('solDatePicker')._flatpickr.open()">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="clearSOLDate()" title="Clear date">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="solWarning" class="mt-2" style="display: none;"></div>
                                <small class="text-muted">Critical deadline - set reminder for this date</small>
                            </div>

                            <hr><h5>Billing</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Billing Type</label>
                                    <select name="billing_type" class="form-select">
                                        <option value="hourly" <%= (!caseData || (typeof caseData !== 'undefined' && caseData && caseData.billing_type === 'hourly')) ? 'selected' : '' %>>Hourly</option>
                                        <option value="flat" <%= (typeof caseData !== 'undefined' && caseData && caseData.billing_type === 'flat') ? 'selected' : '' %>>Flat Fee</option>
                                        <option value="contingency" <%= (typeof caseData !== 'undefined' && caseData && caseData.billing_type === 'contingency') ? 'selected' : '' %>>Contingency</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Hourly Rate ($)</label>
                                    <input type="number" name="billing_rate" class="form-control" step="0.01" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.billing_rate : '250.00' %>">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Retainer Amount ($)</label>
                                    <input type="number" name="retainer_amount" class="form-control" step="0.01" value="<%= (typeof caseData !== 'undefined' && caseData) ? caseData.retainer_amount : '' %>">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea name="notes" class="form-control" rows="3"><%= (typeof caseData !== 'undefined' && caseData) ? caseData.notes : '' %></textarea>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="/cases" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i>Cancel</a>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i><%= (typeof caseData !== 'undefined' && caseData) ? 'Update Case' : 'Create Case' %></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize Flatpickr date picker for SOL
        const solPicker = flatpickr("#solDatePicker", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
            allowInput: true,
            clickOpens: true,
            animate: true,
            monthSelectorType: "dropdown",
            yearSelectorType: "dropdown",
            disableMobile: false,
            onChange: function(selectedDates, dateStr) {
                updateSOLWarning(dateStr);
            },
            onReady: function(selectedDates, dateStr) {
                if (dateStr) updateSOLWarning(dateStr);
            }
        });

        function updateSOLWarning(dateStr) {
            const warningDiv = document.getElementById('solWarning');
            if (!dateStr) {
                warningDiv.style.display = 'none';
                return;
            }

            const solDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = solDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            warningDiv.style.display = 'block';

            if (diffDays < 0) {
                warningDiv.className = 'mt-2 sol-warning danger';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i><strong>EXPIRED!</strong> Statute of limitations passed ' + Math.abs(diffDays) + ' days ago';
            } else if (diffDays === 0) {
                warningDiv.className = 'mt-2 sol-warning danger';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i><strong>EXPIRES TODAY!</strong> Immediate action required';
            } else if (diffDays <= 30) {
                warningDiv.className = 'mt-2 sol-warning danger';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>CRITICAL:</strong> Only ' + diffDays + ' days remaining';
            } else if (diffDays <= 90) {
                warningDiv.className = 'mt-2 sol-warning warning';
                warningDiv.innerHTML = '<i class="fas fa-clock me-2"></i><strong>Warning:</strong> ' + diffDays + ' days remaining (' + Math.floor(diffDays / 30) + ' months)';
            } else if (diffDays <= 365) {
                warningDiv.className = 'mt-2 sol-warning info';
                warningDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + diffDays + ' days remaining (' + Math.floor(diffDays / 30) + ' months)';
            } else {
                const years = Math.floor(diffDays / 365);
                const months = Math.floor((diffDays % 365) / 30);
                warningDiv.className = 'mt-2 sol-warning success';
                warningDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + years + ' year' + (years > 1 ? 's' : '') + (months > 0 ? ', ' + months + ' month' + (months > 1 ? 's' : '') : '') + ' remaining';
            }
        }

        function clearSOLDate() {
            solPicker.clear();
            document.getElementById('solWarning').style.display = 'none';
        }

        // Initialize warning on page load if date exists
        const initialDate = document.getElementById('solDatePicker').value;
        if (initialDate) {
            updateSOLWarning(initialDate);
        }
    </script>
<%- include('../partials/footer') %>
</body>
</html>
