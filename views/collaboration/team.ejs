<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'messages' }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-users me-2"></i>Team Management</h2>
            <p class="text-muted mb-0">Manage team members and roles</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
            <i class="fas fa-user-plus me-2"></i>Invite Member
        </button>
    </div>

    <div class="row mb-4">
        <% roles.forEach(role => { %>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h4><%= users.filter(u => u.role_name === role.name).length %></h4>
                    <small class="text-muted"><%= role.name %></small>
                </div>
            </div>
        </div>
        <% }) %>
    </div>

    <div class="card">
        <div class="card-header"><h5 class="mb-0">Team Members</h5></div>
        <div class="card-body p-0">
            <% if (users.length === 0) { %>
            <div class="text-center py-5"><p class="text-muted">No team members</p></div>
            <% } else { %>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th></tr></thead>
                    <tbody>
                        <% users.forEach(u => { %>
                        <tr class="clickable-row" data-id="<%= u.id %>" style="cursor: pointer;">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                        <%= (u.first_name || u.email)[0].toUpperCase() %>
                                    </div>
                                    <%= u.first_name ? u.first_name + ' ' + (u.last_name || '') : u.email %>
                                </div>
                            </td>
                            <td><%= u.email %></td>
                            <td onclick="event.stopPropagation();">
                                <select class="form-select form-select-sm" style="width: auto;" onchange="updateRole('<%= u.id %>', this.value)">
                                    <% roles.forEach(r => { %>
                                    <option value="<%= r.id %>" <%= u.role_id === r.id ? 'selected' : '' %>><%= r.name %></option>
                                    <% }) %>
                                </select>
                            </td>
                            <td><%= new Date(u.created_at).toLocaleDateString() %></td>
                            <td onclick="event.stopPropagation();">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewActivity('<%= u.id %>')" title="View Activity"><i class="fas fa-history"></i></button>
                                    <button class="btn btn-outline-danger btn-delete" data-id="<%= u.id %>" data-name="<%= u.first_name || u.email %>" title="Remove"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            <% } %>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header"><h5 class="mb-0">Roles & Permissions</h5></div>
        <div class="card-body">
            <div class="row">
                <% roles.forEach(role => { %>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6><i class="fas fa-user-tag me-2"></i><%= role.name %></h6>
                            <small class="text-muted"><%= role.description || 'No description' %></small>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>Invite Team Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label>Email *</label><input type="email" id="invEmail" class="form-control" required></div>
                <div class="mb-3"><label>Role</label><select id="invRole" class="form-select"><% roles.forEach(r => { %><option value="<%= r.id %>"><%= r.name %></option><% }) %></select></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" onclick="sendInvite()">Send Invite</button></div>
        </div>
    </div>
</div>

<!-- Member Detail Modal -->
<div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Member Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="memberDetails"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="btnRemoveMember"><i class="fas fa-trash me-1"></i>Remove</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
var currentMemberId = null;

// Row click handler
document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function() {
        viewMember(this.dataset.id);
    });
});

// Delete button handlers
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        removeMember(this.dataset.id, this.dataset.name);
    });
});

function updateRole(userId, roleId) {
    fetch('/api/users/' + userId + '/role', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role_id: roleId })
    }).then(() => location.reload());
}

function sendInvite() {
    alert('Invite functionality would send email to: ' + document.getElementById('invEmail').value);
    bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
}

function viewActivity(userId) {
    window.location.href = '/activity?user_id=' + userId;
}

function viewMember(userId) {
    currentMemberId = userId;
    const users = <%- JSON.stringify(users) %>;
    const user = users.find(u => u.id == userId);
    if (user) {
        document.getElementById('memberDetails').innerHTML = `
            <table class="table table-borderless">
                <tr><th width="120">Name:</th><td>${user.first_name || ''} ${user.last_name || ''}</td></tr>
                <tr><th>Email:</th><td>${user.email}</td></tr>
                <tr><th>Role:</th><td><span class="badge bg-primary">${user.role_name || 'User'}</span></td></tr>
                <tr><th>Joined:</th><td>${new Date(user.created_at).toLocaleDateString()}</td></tr>
            </table>
        `;
        new bootstrap.Modal(document.getElementById('memberModal')).show();
    }
}

function removeMember(userId, name) {
    if (!confirm('Remove "' + name + '" from the team?')) return;
    fetch('/api/users/' + userId, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + (data.error || 'Failed to remove'));
    });
}

document.getElementById('btnRemoveMember').onclick = function() {
    bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
    const users = <%- JSON.stringify(users) %>;
    const user = users.find(u => u.id == currentMemberId);
    if (user) removeMember(currentMemberId, user.first_name || user.email);
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
</body>
</html>
