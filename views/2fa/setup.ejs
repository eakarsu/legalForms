<%- include('../base-pm', {
    title: 'Two-Factor Authentication',
    description: 'Secure your account with 2FA'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="mb-4">
                <h2><i class="fas fa-shield-alt me-2"></i>Two-Factor Authentication</h2>
                <p class="text-muted">Add an extra layer of security to your account</p>
            </div>

            <% if (user.two_factor_enabled) { %>
            <!-- 2FA Enabled -->
            <div class="card mb-4">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h4>Two-Factor Authentication is Enabled</h4>
                    <p class="text-muted">Your account is protected with an authenticator app.</p>
                    <p><small class="text-muted">Enabled on: <%= user.two_factor_verified_at ? new Date(user.two_factor_verified_at).toLocaleDateString() : 'Unknown' %></small></p>
                    <button class="btn btn-danger mt-3" onclick="disable2FA()">
                        <i class="fas fa-times me-1"></i>Disable 2FA
                    </button>
                </div>
            </div>

            <!-- Backup Codes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-key me-2"></i>Backup Codes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Backup codes can be used to access your account if you lose your authenticator device.</p>
                    <% if (typeof backupCodes !== 'undefined' && backupCodes.length > 0) { %>
                    <div class="alert alert-warning">
                        <strong>Keep these codes safe!</strong> Each code can only be used once.
                    </div>
                    <div class="row">
                        <% backupCodes.forEach(code => { %>
                        <div class="col-6 col-md-4 mb-2">
                            <code class="d-block p-2 bg-light rounded text-center"><%= code %></code>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="text-muted">No backup codes available.</p>
                    <% } %>
                    <button class="btn btn-outline-primary mt-3" onclick="regenerateBackupCodes()">
                        <i class="fas fa-sync me-1"></i>Generate New Codes
                    </button>
                </div>
            </div>

            <!-- Trusted Devices -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-laptop me-2"></i>Trusted Devices</h5>
                </div>
                <div class="card-body">
                    <% if (typeof trustedDevices !== 'undefined' && trustedDevices.length > 0) { %>
                    <div class="list-group">
                        <% trustedDevices.forEach(device => { %>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-<%= device.device_type === 'mobile' ? 'mobile-alt' : device.device_type === 'tablet' ? 'tablet-alt' : 'desktop' %> me-2"></i>
                                <strong><%= device.device_name %></strong>
                                <br><small class="text-muted">Last used: <%= device.last_used_at ? new Date(device.last_used_at).toLocaleDateString() : 'Never' %></small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeDevice('<%= device.id %>')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <% }) %>
                    </div>
                    <% } else { %>
                    <p class="text-muted mb-0">No trusted devices.</p>
                    <% } %>
                </div>
            </div>

            <% } else { %>
            <!-- 2FA Setup -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Set Up Two-Factor Authentication</h5>
                </div>
                <div class="card-body">
                    <div id="setupStep1">
                        <h6>Step 1: Download an Authenticator App</h6>
                        <p class="text-muted">Download and install one of these authenticator apps on your mobile device:</p>
                        <ul>
                            <li>Google Authenticator</li>
                            <li>Microsoft Authenticator</li>
                            <li>Authy</li>
                            <li>1Password</li>
                        </ul>
                        <button class="btn btn-primary" onclick="startSetup()">
                            <i class="fas fa-qrcode me-1"></i>Continue to Setup
                        </button>
                    </div>

                    <div id="setupStep2" class="d-none">
                        <h6>Step 2: Scan QR Code</h6>
                        <p class="text-muted">Open your authenticator app and scan this QR code:</p>
                        <div class="text-center my-4">
                            <div id="qrCode"></div>
                            <p class="mt-3">
                                <small class="text-muted">Can't scan? Enter this code manually:</small>
                                <br><code id="secretKey" class="fs-5"></code>
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="showVerifyStep()">
                            <i class="fas fa-arrow-right me-1"></i>Next
                        </button>
                    </div>

                    <div id="setupStep3" class="d-none">
                        <h6>Step 3: Verify Setup</h6>
                        <p class="text-muted">Enter the 6-digit code from your authenticator app:</p>
                        <form id="verifyForm">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <input type="text" id="verificationCode" class="form-control form-control-lg text-center" maxlength="6" placeholder="000000" pattern="[0-9]{6}" required>
                                </div>
                            </div>
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-check me-1"></i>Verify & Enable 2FA
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
    </div>
</div>

<script>
let setupSecret = '';

async function startSetup() {
    try {
        const response = await fetch('/api/2fa/setup', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            setupSecret = result.secret;
            document.getElementById('qrCode').innerHTML = '<img src="' + result.qrCodeUrl + '" alt="QR Code" style="max-width: 200px;">';
            document.getElementById('secretKey').textContent = result.secret;
            document.getElementById('setupStep1').classList.add('d-none');
            document.getElementById('setupStep2').classList.remove('d-none');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Setup failed');
    }
}

function showVerifyStep() {
    document.getElementById('setupStep2').classList.add('d-none');
    document.getElementById('setupStep3').classList.remove('d-none');
}

document.getElementById('verifyForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const code = document.getElementById('verificationCode').value;

    try {
        const response = await fetch('/api/2fa/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, secret: setupSecret })
        });
        const result = await response.json();

        if (result.success) {
            alert('Two-factor authentication enabled successfully!');
            window.location.reload();
        } else {
            alert('Invalid code. Please try again.');
        }
    } catch (error) {
        alert('Verification failed');
    }
});

async function disable2FA() {
    if (!confirm('Are you sure you want to disable two-factor authentication? This will make your account less secure.')) return;

    const code = prompt('Enter a code from your authenticator app to confirm:');
    if (!code) return;

    try {
        const response = await fetch('/api/2fa/disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
        });
        const result = await response.json();

        if (result.success) {
            alert('Two-factor authentication disabled.');
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to disable 2FA');
    }
}

async function regenerateBackupCodes() {
    if (!confirm('This will invalidate your existing backup codes. Continue?')) return;

    try {
        const response = await fetch('/api/2fa/backup-codes', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            alert('New backup codes generated. Please save them securely.');
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to generate backup codes');
    }
}

async function removeDevice(id) {
    if (!confirm('Remove this trusted device?')) return;

    try {
        const response = await fetch('/api/2fa/devices/' + id, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to remove device');
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
