<%- include('../base-pm', {
    title: 'Parties Database',
    description: 'Manage conflict checking parties'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/conflicts">Conflict Checking</a></li>
                    <li class="breadcrumb-item active">Parties Database</li>
                </ol>
            </nav>
            <h2><i class="fas fa-users me-2"></i>Parties Database</h2>
            <p class="text-muted mb-0">All parties tracked for conflict checking</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPartyModal">
            <i class="fas fa-plus me-1"></i>Add Party
        </button>
    </div>

    <!-- Search -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search" class="form-control" placeholder="Search parties..." value="<%= filters.search || '' %>">
                </div>
                <div class="col-md-3">
                    <select name="party_type" class="form-select">
                        <option value="">All Types</option>
                        <option value="individual" <%= filters.party_type === 'individual' ? 'selected' : '' %>>Individual</option>
                        <option value="company" <%= filters.party_type === 'company' ? 'selected' : '' %>>Company</option>
                        <option value="government" <%= filters.party_type === 'government' ? 'selected' : '' %>>Government</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="role" class="form-select">
                        <option value="">All Roles</option>
                        <option value="client" <%= filters.role === 'client' ? 'selected' : '' %>>Client</option>
                        <option value="opposing_party" <%= filters.role === 'opposing_party' ? 'selected' : '' %>>Opposing Party</option>
                        <option value="witness" <%= filters.role === 'witness' ? 'selected' : '' %>>Witness</option>
                        <option value="expert" <%= filters.role === 'expert' ? 'selected' : '' %>>Expert</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Parties Table -->
    <div class="card">
        <div class="card-body">
            <% if (parties.length > 0) { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Role</th>
                            <th>Case</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% parties.forEach(party => { %>
                        <tr>
                            <td>
                                <strong><%= party.name %></strong>
                                <%
                                let aliases = party.aliases || [];
                                if (typeof aliases === 'string') {
                                    try { aliases = JSON.parse(aliases); } catch(e) { aliases = []; }
                                }
                                %>
                                <% if (aliases && aliases.length > 0) { %>
                                <br><small class="text-muted">AKA: <%= aliases.join(', ') %></small>
                                <% } %>
                            </td>
                            <td><span class="badge bg-secondary"><%= party.party_type %></span></td>
                            <td><%= party.role || 'N/A' %></td>
                            <td>
                                <% if (party.case_title) { %>
                                <a href="/cases/<%= party.case_id %>"><%= party.case_title %></a>
                                <% } else { %>
                                <span class="text-muted">N/A</span>
                                <% } %>
                            </td>
                            <td><%= new Date(party.created_at).toLocaleDateString() %></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editParty('<%= party.id %>')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteParty('<%= party.id %>')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5>No Parties Found</h5>
                <p class="text-muted">Add parties manually or they will be automatically added from cases.</p>
            </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Add Party Modal -->
<div class="modal fade" id="addPartyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Party</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPartyForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Party Type</label>
                        <select name="party_type" class="form-select" required>
                            <option value="individual">Individual</option>
                            <option value="company">Company</option>
                            <option value="government">Government Entity</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select name="role" class="form-select">
                            <option value="">Select role...</option>
                            <option value="client">Client</option>
                            <option value="opposing_party">Opposing Party</option>
                            <option value="witness">Witness</option>
                            <option value="expert">Expert</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Related Case</label>
                        <select name="case_id" class="form-select">
                            <option value="">No specific case</option>
                            <% if (typeof cases !== 'undefined') { cases.forEach(c => { %>
                            <option value="<%= c.id %>"><%= c.title %></option>
                            <% }) } %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Aliases (comma separated)</label>
                        <input type="text" name="aliases" class="form-control" placeholder="John Doe, J. Doe">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Party</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('addPartyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    if (data.aliases) {
        data.aliases = data.aliases.split(',').map(a => a.trim()).filter(a => a);
    }

    try {
        const response = await fetch('/api/conflicts/parties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to add party');
    }
});

async function deleteParty(id) {
    if (!confirm('Are you sure you want to delete this party?')) return;

    try {
        const response = await fetch('/api/conflicts/parties/' + id, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to delete party');
    }
}

function editParty(id) {
    alert('Edit functionality - would open modal with party details');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
</body>
</html>
