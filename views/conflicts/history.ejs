<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'conflicts' }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-history me-2"></i>Conflict Check History</h2>
            <p class="text-muted mb-0">View all past conflict checks</p>
        </div>
        <a href="/conflicts/new" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>New Check
        </a>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Search Terms</th>
                        <th>Result</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (checks.length === 0) { %>
                    <tr><td colspan="5" class="text-center text-muted py-4">No conflict checks yet</td></tr>
                    <% } else { %>
                    <% checks.forEach(check => { %>
                    <tr class="clickable-row" data-href="/conflicts/<%= check.id %>" style="cursor: pointer;">
                        <td><%= new Date(check.created_at).toLocaleDateString() %></td>
                        <td><%= check.client_first ? check.client_first + ' ' + check.client_last : 'N/A' %></td>
                        <td><%= JSON.stringify(check.search_terms).substring(0, 50) %>...</td>
                        <td>
                            <span class="badge bg-<%= check.status === 'clear' ? 'success' : check.status === 'conflict_found' ? 'danger' : 'warning' %>">
                                <%= check.status %>
                            </span>
                        </td>
                        <td onclick="event.stopPropagation();">
                            <a href="/conflicts/<%= check.id %>" class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger btn-delete" data-id="<%= check.id %>">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Row click handler
document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function() {
        window.location.href = this.dataset.href;
    });
});

// Delete handler
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        if (!confirm('Are you sure you want to delete this conflict check record?')) return;

        const id = this.dataset.id;
        try {
            const response = await fetch(`/api/conflicts/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                this.closest('tr').remove();
            } else {
                alert('Error: ' + (result.error || 'Failed to delete'));
            }
        } catch (error) {
            alert('Delete failed');
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
