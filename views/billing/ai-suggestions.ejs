<%- include('../base-pm', {
    title: 'AI Billing Suggestions',
    description: 'AI-powered billing optimization'
}) %>

<%- include('../partials/pm-nav') %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-robot me-2"></i>AI Billing Suggestions</h2>
            <p class="text-muted mb-0">AI-identified billable items from case notes</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.total_suggestions || 0 %></h3>
                    <small>Total Suggestions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.pending_count || 0 %></h3>
                    <small>Pending Review</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h3 class="mb-0"><%= stats.accepted_count || 0 %></h3>
                    <small>Accepted</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h3 class="mb-0">$<%= parseFloat(stats.accepted_value || 0).toFixed(2) %></h3>
                    <small>Accepted Value</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan for Billable Items -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-search-dollar me-2"></i>Scan for Billable Items</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">AI will analyze your recent case notes to identify potentially billable activities that haven't been logged.</p>
            <form id="scanForm">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Case (Optional)</label>
                        <select class="form-select" name="case_id" id="caseSelect">
                            <option value="">All Cases</option>
                            <% if (typeof cases !== 'undefined') { cases.forEach(c => { %>
                            <option value="<%= c.id %>"><%= c.case_number %> - <%= c.title %></option>
                            <% }) } %>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Time Period</label>
                        <select class="form-select" name="days">
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-info btn-lg" id="loadExampleBtn">
                        <i class="fas fa-flask me-1"></i>Load Example
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" id="scanBtn">
                        <i class="fas fa-robot me-1"></i>Scan Notes with AI
                    </button>
                </div>
            </form>

            <!-- Example Case Notes Input -->
            <div class="mt-3" id="exampleSection" style="display: none;">
                <label class="form-label">Sample Case Notes (for demo)</label>
                <textarea class="form-control" name="sample_notes" id="sampleNotes" rows="4" placeholder="Paste case notes to analyze..."></textarea>
            </div>
        </div>
    </div>

    <!-- Pending Suggestions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Billing Suggestions</h5>
        </div>
        <div class="card-body">
            <% const pendingSuggestions = suggestions.filter(s => s.status === 'pending'); %>
            <% if (pendingSuggestions.length > 0) { %>
            <div class="list-group">
                <% pendingSuggestions.forEach(s => { %>
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><%= s.suggested_description %></h6>
                            <p class="mb-1 text-muted">
                                <span class="badge bg-secondary"><%= s.suggested_category %></span>
                                <% if (s.case_title) { %> | Case: <%= s.case_title %><% } %>
                            </p>
                            <small>
                                <strong><%= s.suggested_duration_minutes %> min</strong> |
                                <strong>$<%= parseFloat(s.suggested_amount || 0).toFixed(2) %></strong> |
                                Confidence: <%= Math.round((s.confidence_score || 0) * 100) %>%
                            </small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success accept-btn" data-id="<%= s.id %>">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn btn-sm btn-outline-danger reject-btn" data-id="<%= s.id %>">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
            <% } else { %>
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h5>All caught up!</h5>
                <p class="text-muted">No pending billing suggestions</p>
            </div>
            <% } %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load Example Data
document.getElementById('loadExampleBtn').addEventListener('click', function() {
    document.getElementById('exampleSection').style.display = 'block';
    document.getElementById('sampleNotes').value = `March 15, 2024 - Called client to discuss settlement offer from defendant. Call lasted 45 minutes. Client wants to counter at $75,000. Explained risks and benefits of going to trial vs. settling.

March 16, 2024 - Drafted counter-offer letter to opposing counsel. Reviewed case file and updated damage calculations. Approximately 2 hours of work.

March 18, 2024 - Received call from opposing counsel regarding our counter. Brief 15-minute discussion. They will present to their client.

March 20, 2024 - Prepared for and attended mediation session. Full day (8 hours) at mediator's office. Settlement reached at $65,000.

March 21, 2024 - Drafted settlement agreement and release documents. Reviewed final terms with client via phone (30 min call). Sent documents to opposing counsel for signature.`;
});

// Scan for billable items
document.getElementById('scanForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('scanBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scanning...';

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    data.sample_notes = document.getElementById('sampleNotes').value;

    try {
        const res = await fetch('/api/ai-billing/scan-notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (result.success) {
            alert(`Found ${result.suggestionsCount} potential billable items!`);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-robot me-1"></i>Scan Notes';
    }
});

document.querySelectorAll('.accept-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const id = this.dataset.id;
        try {
            const res = await fetch(`/api/ai-billing/suggestions/${id}/accept`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
});

document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const id = this.dataset.id;
        try {
            const res = await fetch(`/api/ai-billing/suggestions/${id}/reject`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                location.reload();
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });
});
</script>
<%- include('../partials/footer') %>
</body>
</html>
