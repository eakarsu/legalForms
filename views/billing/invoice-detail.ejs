<%- include('../base-pm', { title: title }) %>
<%- include('../partials/pm-nav', { active: 'billing' }) %>

<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/billing/invoices">Invoices</a></li>
            <li class="breadcrumb-item active"><%= invoice.invoice_number %></li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Invoice <%= invoice.invoice_number %></h4>
                    <span class="badge bg-<%= invoice.status === 'paid' ? 'success' : invoice.status === 'sent' ? 'primary' : invoice.status === 'overdue' ? 'danger' : 'secondary' %> fs-6"><%= invoice.status.toUpperCase() %></span>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Bill To:</h6>
                            <p class="mb-0"><strong><%= invoice.company_name || (invoice.first_name + ' ' + invoice.last_name) %></strong></p>
                            <% if (invoice.client_email) { %><p class="mb-0"><%= invoice.client_email %></p><% } %>
                            <% if (invoice.client_address) { %><p class="mb-0"><%= invoice.client_address %><br><%= invoice.client_city %>, <%= invoice.client_state %> <%= invoice.client_zip %></p><% } %>
                        </div>
                        <div class="col-md-6 text-end">
                            <p><strong>Invoice Date:</strong> <%= new Date(invoice.created_at).toLocaleDateString() %></p>
                            <p><strong>Due Date:</strong> <%= invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A' %></p>
                            <% if (invoice.case_title) { %><p><strong>Matter:</strong> <%= invoice.case_title %></p><% } %>
                        </div>
                    </div>

                    <table class="table">
                        <thead><tr><th>Description</th><th class="text-end">Qty</th><th class="text-end">Rate</th><th class="text-end">Amount</th></tr></thead>
                        <tbody>
                            <% items.forEach(item => { %>
                                <tr><td><%= item.description %></td><td class="text-end"><%= item.quantity %></td><td class="text-end">$<%= parseFloat(item.rate || 0).toFixed(2) %></td><td class="text-end">$<%= parseFloat(item.amount || 0).toFixed(2) %></td></tr>
                            <% }) %>
                            <% if (items.length === 0) { %><tr><td colspan="4" class="text-center text-muted">No line items</td></tr><% } %>
                        </tbody>
                        <tfoot>
                            <tr><td colspan="3" class="text-end"><strong>Subtotal:</strong></td><td class="text-end">$<%= parseFloat(invoice.subtotal || 0).toFixed(2) %></td></tr>
                            <% if (invoice.tax_amount > 0) { %><tr><td colspan="3" class="text-end">Tax (<%= invoice.tax_rate %>%):</td><td class="text-end">$<%= parseFloat(invoice.tax_amount).toFixed(2) %></td></tr><% } %>
                            <tr class="table-dark"><td colspan="3" class="text-end"><strong>Total:</strong></td><td class="text-end"><strong>$<%= parseFloat(invoice.total || 0).toFixed(2) %></strong></td></tr>
                            <tr><td colspan="3" class="text-end">Amount Paid:</td><td class="text-end text-success">$<%= parseFloat(invoice.amount_paid || 0).toFixed(2) %></td></tr>
                            <tr><td colspan="3" class="text-end"><strong>Balance Due:</strong></td><td class="text-end text-danger"><strong>$<%= parseFloat((invoice.total || 0) - (invoice.amount_paid || 0)).toFixed(2) %></strong></td></tr>
                        </tfoot>
                    </table>

                    <% if (invoice.notes) { %><hr><p><strong>Notes:</strong> <%= invoice.notes %></p><% } %>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Actions</h5></div>
                <div class="card-body">
                    <% if (invoice.status === 'draft') { %><button class="btn btn-success w-100 mb-2" id="btnSendInvoice"><i class="fas fa-paper-plane me-2"></i>Send Invoice</button><% } %>
                    <% if (invoice.status !== 'paid') { %><button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#paymentModal"><i class="fas fa-dollar-sign me-2"></i>Record Payment</button><% } %>
                    <button class="btn btn-outline-secondary w-100 mb-2" id="btnPrint"><i class="fas fa-print me-2"></i>Print</button>
                    <% if (invoice.status === 'draft') { %>
                    <button class="btn btn-outline-danger w-100" id="btnDeleteInvoice"><i class="fas fa-trash me-2"></i>Delete Invoice</button>
                    <% } %>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h5 class="mb-0">Payments</h5></div>
                <div class="card-body">
                    <% if (payments.length === 0) { %><p class="text-muted">No payments recorded</p><% } else { %>
                        <% payments.forEach(p => { %>
                            <div class="mb-2 pb-2 border-bottom">
                                <div class="d-flex justify-content-between"><strong>$<%= parseFloat(p.amount).toFixed(2) %></strong><small><%= new Date(p.payment_date).toLocaleDateString() %></small></div>
                                <small class="text-muted"><%= p.payment_method %><% if (p.reference_number) { %> - <%= p.reference_number %><% } %></small>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Record Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label">Amount</label><input type="number" id="payAmount" name="amount" class="form-control" step="0.01" value="<%= parseFloat((invoice.total || 0) - (invoice.amount_paid || 0)).toFixed(2) %>"></div>
                <div class="mb-3"><label class="form-label">Method</label><select id="payMethod" name="method" class="form-select"><option value="credit_card">Credit Card</option><option value="check">Check</option><option value="wire">Wire</option><option value="ach">ACH</option><option value="cash">Cash</option></select></div>
                <div class="mb-3"><label class="form-label">Reference #</label><input type="text" id="payRef" name="reference" class="form-control"></div>
                <div class="mb-3"><label class="form-label">Date</label><input type="date" id="payDate" name="date" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="btnRecordPayment">Record Payment</button></div>
        </div>
    </div>
</div>

<script>
    function sendInvoice() {
        fetch('/api/invoices/<%= invoice.id %>/send', { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) location.reload();
            else alert('Error sending invoice: ' + (d.error || 'Unknown error'));
        })
        .catch(err => { alert('Failed to send invoice'); console.error(err); });
    }
    function recordPayment() {
        fetch('/api/invoices/<%= invoice.id %>/payments', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: document.getElementById('payAmount').value, payment_method: document.getElementById('payMethod').value, reference_number: document.getElementById('payRef').value, payment_date: document.getElementById('payDate').value })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) location.reload();
            else alert('Error recording payment: ' + (d.error || 'Unknown error'));
        })
        .catch(err => { alert('Failed to record payment'); console.error(err); });
    }
    function deleteInvoice() {
        if (confirm('Delete this invoice? This cannot be undone.')) {
            fetch('/api/invoices/<%= invoice.id %>', { method: 'DELETE' })
            .then(r => r.json())
            .then(data => { if (data.success) window.location.href = '/billing/invoices'; else alert('Error: ' + (data.error || 'Failed')); })
            .catch(err => { alert('Failed to delete invoice'); console.error(err); });
        }
    }

    var sendBtn = document.getElementById('btnSendInvoice');
    if (sendBtn) sendBtn.addEventListener('click', sendInvoice);

    document.getElementById('btnPrint').addEventListener('click', function() { window.print(); });
    document.getElementById('btnRecordPayment').addEventListener('click', recordPayment);

    var deleteBtn = document.getElementById('btnDeleteInvoice');
    if (deleteBtn) deleteBtn.addEventListener('click', deleteInvoice);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
</body>
</html>
