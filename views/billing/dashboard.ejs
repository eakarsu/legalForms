<%- include('../base-pm', { title: title }) %>

<%- include('../partials/pm-nav', { active: 'billing' }) %>

<div class="pm-container">
        <div class="pm-header">
            <div class="pm-header-content">
                <h1><i class="fas fa-dollar-sign me-2"></i>Billing Dashboard</h1>
                <p class="text-muted">Track time, manage invoices, and monitor payments</p>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h3 class="mb-0">$<%= parseFloat(summary.unbilled_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></h3>
                        <small>Unbilled Time</small>
                        <div class="mt-1"><small><%= (summary.unbilled_minutes / 60).toFixed(1) %> hours</small></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h3 class="mb-0">$<%= parseFloat(invoiceSummary.outstanding || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></h3>
                        <small>Outstanding</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h3 class="mb-0">$<%= parseFloat(invoiceSummary.overdue || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></h3>
                        <small>Overdue</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h3 class="mb-0">$<%= parseFloat(invoiceSummary.collected_this_month || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></h3>
                        <small>Collected This Month</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-md-3"><a href="/billing/time" class="btn btn-outline-primary w-100 py-3"><i class="fas fa-stopwatch me-2"></i>Track Time</a></div>
            <div class="col-md-3"><a href="/billing/invoices" class="btn btn-outline-primary w-100 py-3"><i class="fas fa-file-invoice-dollar me-2"></i>Create Invoice</a></div>
            <div class="col-md-3"><a href="/billing/expenses" class="btn btn-outline-primary w-100 py-3"><i class="fas fa-receipt me-2"></i>Log Expense</a></div>
            <div class="col-md-3"><a href="/reports/revenue" class="btn btn-outline-primary w-100 py-3"><i class="fas fa-chart-line me-2"></i>Revenue Report</a></div>
        </div>

        <div class="row">
            <!-- Recent Time Entries -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Recent Time Entries</h5>
                        <a href="/billing/time" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <% if (recentTime.length === 0) { %>
                            <div class="text-center py-4"><p class="text-muted">No time entries yet</p></div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead><tr><th>Date</th><th>Case/Client</th><th>Hours</th><th>Amount</th></tr></thead>
                                    <tbody>
                                        <% recentTime.forEach(te => { %>
                                            <tr class="clickable-row" data-id="<%= te.id %>" data-type="time" style="cursor:pointer">
                                                <td><%= new Date(te.date).toLocaleDateString() %></td>
                                                <td><%= te.case_title || (te.company_name || te.first_name) || 'N/A' %></td>
                                                <td><%= (te.duration_minutes / 60).toFixed(1) %></td>
                                                <td>$<%= parseFloat(te.amount || 0).toFixed(0) %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Recent Invoices -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Recent Invoices</h5>
                        <a href="/billing/invoices" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body p-0">
                        <% if (recentInvoices.length === 0) { %>
                            <div class="text-center py-4"><p class="text-muted">No invoices yet</p></div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead><tr><th>Invoice</th><th>Client</th><th>Total</th><th>Status</th></tr></thead>
                                    <tbody>
                                        <% recentInvoices.forEach(inv => { %>
                                            <tr class="clickable-row" data-href="/billing/invoices/<%= inv.id %>" style="cursor:pointer">
                                                <td><%= inv.invoice_number %></td>
                                                <td><%= inv.company_name || (inv.first_name + ' ' + inv.last_name) || 'N/A' %></td>
                                                <td>$<%= parseFloat(inv.total || 0).toLocaleString() %></td>
                                                <td><span class="badge bg-<%= inv.status === 'paid' ? 'success' : inv.status === 'sent' ? 'primary' : inv.status === 'overdue' ? 'danger' : 'secondary' %>"><%= inv.status %></span></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Entry Detail Modal -->
    <div class="modal fade" id="viewTimeEntryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-stopwatch me-2"></i>Time Entry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="timeEntryDetails"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="btnDeleteTimeEntry"><i class="fas fa-trash me-1"></i>Delete</button>
                    <button type="button" class="btn btn-outline-primary" id="btnEditTimeEntry"><i class="fas fa-edit me-1"></i>Edit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var currentTimeEntryId = null;

        // Clickable rows event listeners
        document.querySelectorAll('.clickable-row').forEach(function(row) {
            row.addEventListener('click', function() {
                if (this.dataset.href) {
                    window.location.href = this.dataset.href;
                } else if (this.dataset.type === 'time' && this.dataset.id) {
                    viewTimeEntry(this.dataset.id);
                }
            });
        });

        function viewTimeEntry(id) {
            currentTimeEntryId = id;
            fetch('/api/time-entries/' + id)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var te = data.entry || data.timeEntry;
                if (te) {
                    var html = '<table class="table table-borderless">' +
                        '<tr><th width="140"><i class="fas fa-calendar text-muted me-2"></i>Date:</th><td>' + new Date(te.date).toLocaleDateString() + '</td></tr>' +
                        '<tr><th><i class="fas fa-clock text-muted me-2"></i>Duration:</th><td><strong>' + (te.duration_minutes / 60).toFixed(2) + ' hours</strong></td></tr>' +
                        '<tr><th><i class="fas fa-dollar-sign text-muted me-2"></i>Rate:</th><td>$' + parseFloat(te.hourly_rate || 0).toFixed(2) + '/hr</td></tr>' +
                        '<tr><th><i class="fas fa-money-bill text-muted me-2"></i>Amount:</th><td><strong>$' + parseFloat(te.amount || 0).toFixed(2) + '</strong></td></tr>' +
                        '<tr><th><i class="fas fa-briefcase text-muted me-2"></i>Case:</th><td>' + (te.case_title || 'N/A') + '</td></tr>' +
                        '<tr><th><i class="fas fa-tasks text-muted me-2"></i>Activity:</th><td>' + (te.activity_type || 'N/A') + '</td></tr>' +
                        '<tr><th><i class="fas fa-check-circle text-muted me-2"></i>Billable:</th><td>' + (te.is_billable ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>') + '</td></tr>' +
                        '<tr><th><i class="fas fa-file-invoice text-muted me-2"></i>Billed:</th><td>' + (te.is_billed ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-warning">Not yet</span>') + '</td></tr>' +
                        '</table>' +
                        '<div class="mt-3"><strong><i class="fas fa-align-left me-2"></i>Description:</strong><p class="mt-2 text-muted">' + (te.description || 'No description') + '</p></div>';
                    document.getElementById('timeEntryDetails').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('viewTimeEntryModal')).show();
                }
            });
        }

        document.getElementById('btnEditTimeEntry').onclick = function() {
            bootstrap.Modal.getInstance(document.getElementById('viewTimeEntryModal')).hide();
            window.location = '/billing/time?edit=' + currentTimeEntryId;
        };

        document.getElementById('btnDeleteTimeEntry').onclick = function() {
            if (confirm('Delete this time entry?')) {
                fetch('/api/time-entries/' + currentTimeEntryId, { method: 'DELETE' })
                .then(function() { location.reload(); });
            }
        };
    </script>
<%- include('../partials/footer') %>
</body>
</html>
